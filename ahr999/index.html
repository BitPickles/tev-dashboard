<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>AHR999 指标 — Crypto3D</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <script src="../indicators/js/chart-utils.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo">
          <img src="../logo.svg" alt="3D" class="logo-icon">
          <span class="logo-text">Crypto3D</span>
        </a>
        <div class="nav-links">
          <a href="../" data-zh="首页" data-en="Home">首页</a>
          <div class="lang-switch" onclick="LangUtils.toggle(); updateDisplay();">
            <span id="lang-zh" class="active">中文</span>
            <span>/</span>
            <span id="lang-en">EN</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">AHR999 <span data-zh="指标" data-en="Index">指标</span></h1>
        <p class="page-subtitle" data-zh="比特币长期价值偏离程度观测" data-en="Bitcoin long-term value deviation indicator">比特币长期价值偏离程度观测</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label" data-zh="当前值" data-en="Current">当前值</div>
          <div class="stat-value" id="current-value">—</div>
          <div class="stat-hint" id="current-zone">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="BTC 价格" data-en="BTC Price">BTC 价格</div>
          <div class="stat-value" id="current-price" style="color: var(--text-primary)">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="200日定投成本" data-en="200d DCA Cost">200日定投成本</div>
          <div class="stat-value" id="current-cost" style="color: var(--purple); font-size: 16px;">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="拟合价格" data-en="Fitted Price">拟合价格</div>
          <div class="stat-value" id="current-fitted" style="color: var(--cyan); font-size: 16px;">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="操作建议" data-en="Suggestion">操作建议</div>
          <div class="stat-value" id="suggestion" style="font-size: 18px;">—</div>
          <div class="stat-hint" data-zh="仅供参考" data-en="Reference only">仅供参考</div>
        </div>
      </div>

      <div class="zone-legend">
        <div class="zone-item">
          <div class="zone-dot buy"></div>
          <span data-zh="< 0.45 抄底区" data-en="< 0.45 Buy Zone">< 0.45 抄底区</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot dca"></div>
          <span data-zh="0.45 ~ 1.2 定投区" data-en="0.45 ~ 1.2 DCA Zone">0.45 ~ 1.2 定投区</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot wait"></div>
          <span data-zh="> 1.2 观望区" data-en="> 1.2 Wait Zone">> 1.2 观望区</span>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title" data-zh="AHR999 历史走势" data-en="AHR999 History">AHR999 历史走势</div>
          <div class="chart-legend">
            <div class="legend-item scale-toggle" onclick="toggleScale()" title="切换线性/对数坐标">
              <span id="scale-label">Log</span>
            </div>
            <div class="legend-item fixed" title="阈值线始终显示">
              <div class="legend-line dashed" style="color: #ef4444;"></div>
              <span>1.2</span>
            </div>
            <div class="legend-item fixed" title="阈值线始终显示">
              <div class="legend-line dashed" style="color: #22c55e;"></div>
              <span>0.45</span>
            </div>
            <div class="legend-item" data-series="ahr999" onclick="toggleSeries('ahr999')">
              <div class="legend-line" style="background: #3b82f6;"></div>
              <span>AHR999</span>
            </div>
            <div class="legend-item disabled" data-series="price" onclick="toggleSeries('price')">
              <div class="legend-line" style="background: #f59e0b;"></div>
              <span data-zh="BTC价格" data-en="BTC Price">BTC价格</span>
            </div>
            <div class="legend-item disabled" data-series="cost" onclick="toggleSeries('cost')">
              <div class="legend-line" style="background: #a855f7;"></div>
              <span data-zh="200日成本" data-en="200d Cost">200日成本</span>
            </div>
            <div class="legend-item disabled" data-series="fitted" onclick="toggleSeries('fitted')">
              <div class="legend-line" style="background: #06b6d4;"></div>
              <span data-zh="拟合价格" data-en="Fitted">拟合价格</span>
            </div>
          </div>
        </div>
        <div class="chart-wrapper" id="chart-container"></div>
        <div class="chart-tooltip" id="chart-tooltip">
          <div class="tooltip-date" id="tooltip-date">—</div>
          <div class="tooltip-item" id="tooltip-ahr999" style="display: none;">
            <div class="tooltip-dot" style="background: #3b82f6;"></div>
            <span class="tooltip-label">AHR999:</span>
            <span class="tooltip-value" id="tooltip-ahr999-value">—</span>
          </div>
          <div class="tooltip-item" id="tooltip-price" style="display: none;">
            <div class="tooltip-dot" style="background: #f59e0b;"></div>
            <span class="tooltip-label">BTC:</span>
            <span class="tooltip-value" id="tooltip-price-value">—</span>
          </div>
          <div class="tooltip-item" id="tooltip-cost" style="display: none;">
            <div class="tooltip-dot" style="background: #a855f7;"></div>
            <span class="tooltip-label">200d:</span>
            <span class="tooltip-value" id="tooltip-cost-value">—</span>
          </div>
          <div class="tooltip-item" id="tooltip-fitted" style="display: none;">
            <div class="tooltip-dot" style="background: #06b6d4;"></div>
            <span class="tooltip-label" data-zh="拟合:" data-en="Fit:">拟合:</span>
            <span class="tooltip-value" id="tooltip-fitted-value">—</span>
          </div>
        </div>
        <div class="chart-hint" data-zh="💡 拖动平移 · 滚轮缩放 · 双击重置" data-en="💡 Drag to pan · Scroll to zoom · Double-click to reset">💡 拖动平移 · 滚轮缩放 · 双击重置</div>
      </div>
      <div class="data-update-time" id="data-update-time" data-zh="数据更新: —" data-en="Data updated: —">数据更新: —</div>

      <div class="info-section">
        <h2 class="info-title" data-zh="指标说明" data-en="About AHR999">指标说明</h2>
        <div class="info-text">
          <p data-zh="AHR999 是由「九神」提出的比特币长期估值指标，用于观察比特币现价与历史定投成本、长期估值之间的偏离程度。" 
             data-en="AHR999 is a long-term Bitcoin valuation indicator proposed by '九神', used to observe the deviation between current price and historical DCA cost / long-term valuation.">
            AHR999 是由「九神」提出的比特币长期估值指标，用于观察比特币现价与历史定投成本、长期估值之间的偏离程度。
          </p>
          <div class="formula">AHR999 = (Price / 200日定投成本) × (Price / 币龄估值)</div>
          <p data-zh="• 当 AHR999 < 0.45 时，处于抄底区，历史上是较好的买入时机" 
             data-en="• When AHR999 < 0.45, it's in the buy zone, historically a good time to buy">
            • 当 AHR999 < 0.45 时，处于抄底区，历史上是较好的买入时机
          </p>
          <p data-zh="• 当 0.45 ≤ AHR999 ≤ 1.2 时，处于定投区，适合定期定额投资" 
             data-en="• When 0.45 ≤ AHR999 ≤ 1.2, it's in the DCA zone, suitable for regular investment">
            • 当 0.45 ≤ AHR999 ≤ 1.2 时，处于定投区，适合定期定额投资
          </p>
          <p data-zh="• 当 AHR999 > 1.2 时，处于观望区，价格可能偏高" 
             data-en="• When AHR999 > 1.2, it's in the wait zone, price may be overvalued">
            • 当 AHR999 > 1.2 时，处于观望区，价格可能偏高
          </p>
          <div class="disclaimer" 
               data-zh="⚠️ 没有永远有效的指标。AHR999 诞生于两个周期以前，在新的市场环境下可能存在一定局限性，请酌情参考，理性决策。"
               data-en="⚠️ No indicator is forever effective. AHR999 was created two cycles ago and may have limitations in the current market environment. Please use it as a reference and make rational decisions.">
            ⚠️ 没有永远有效的指标。AHR999 诞生于两个周期以前，在新的市场环境下可能存在一定局限性，请酌情参考，理性决策。
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="footer-text">© 2026 Crypto3D</p>
    </div>
  </footer>

  <script>
    // === State ===
    let chart = null;
    let series = {};
    let zones = {};
    let seriesVisible = { ahr999: true, price: false, cost: false, fitted: false };
    let isLogScale = true;
    let defaultRange = null;
    let historyData = {};
    let currentData = null;

    // === AHR999 Zone Logic ===
    function getZoneInfo(value) {
      const lang = LangUtils.get();
      if (value < 0.45) {
        return { 
          class: 'buy', 
          zone: lang === 'zh' ? '抄底区' : 'Buy Zone',
          suggestion: lang === 'zh' ? '🟢 抄底' : '🟢 Buy'
        };
      } else if (value <= 1.2) {
        return { 
          class: 'dca', 
          zone: lang === 'zh' ? '定投区' : 'DCA Zone',
          suggestion: lang === 'zh' ? '🟡 定投' : '🟡 DCA'
        };
      } else {
        return { 
          class: 'wait', 
          zone: lang === 'zh' ? '观望区' : 'Wait Zone',
          suggestion: lang === 'zh' ? '🔴 观望' : '🔴 Wait'
        };
      }
    }

    // === Chart Controls ===
    function toggleSeries(name) {
      toggleSeriesVisibility(series, seriesVisible, name, { ahr999: zones });
      const el = document.getElementById(`tooltip-${name}`);
      if (el) el.style.display = seriesVisible[name] ? 'flex' : 'none';
    }

    function toggleScale() {
      isLogScale = toggleScaleMode(chart, isLogScale, 'scale-label', ['right', 'left']);
    }

    function resetChart() {
      if (chart && defaultRange) chart.timeScale().setVisibleRange(defaultRange);
    }

    // === Display Update ===
    function updateDisplay() {
      if (!currentData) return;
      const current = currentData.current;
      const zoneInfo = getZoneInfo(current.value);

      document.getElementById('current-value').textContent = current.value.toFixed(4);
      document.getElementById('current-value').className = `stat-value ${zoneInfo.class}`;
      document.getElementById('current-zone').textContent = zoneInfo.zone;
      document.getElementById('current-price').textContent = '$' + current.price.toLocaleString();
      document.getElementById('current-cost').textContent = '$' + current.cost_200d.toLocaleString();
      document.getElementById('current-fitted').textContent = '$' + current.fitted_price.toLocaleString();
      document.getElementById('suggestion').textContent = zoneInfo.suggestion;

      if (currentData.updated_at) {
        const prefix = LangUtils.get() === 'zh' ? '数据更新: ' : 'Data updated: ';
        document.getElementById('data-update-time').textContent = prefix + currentData.updated_at;
      }
    }

    // === Data Loading ===
    async function loadData() {
      try {
        const res = await fetch('../indicators/data/ahr999.json');
        currentData = await res.json();
        updateDisplay();
        drawChart(currentData.history);
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    // === Chart Drawing ===
    function drawChart(history) {
      chart = createChart('chart-container');

      // Prepare data
      const ahr999Data = history.map(d => ({ time: d.date, value: d.ahr999 }));
      const priceData = history.map(d => ({ time: d.date, value: d.close }));
      const costData = history.map(d => ({ time: d.date, value: d.cost_200d }));
      const fittedData = history.map(d => ({ time: d.date, value: d.fitted_price }));
      historyData = buildHistoryLookup(history);

      const firstDate = history[0].date;
      const lastDate = history[history.length - 1].date;

      // Zone backgrounds
      zones.green = createZoneSeries(chart, 0.45, {
        bottomFill1: 'rgba(34, 197, 94, 0.08)',
        bottomFill2: 'rgba(34, 197, 94, 0.25)',
      });
      zones.green.setData(ahr999Data);

      zones.red = createZoneSeries(chart, 1.2, {
        topFill1: 'rgba(239, 68, 68, 0.08)',
        topFill2: 'rgba(239, 68, 68, 0.25)',
      });
      zones.red.setData(ahr999Data);

      // AHR999 Series with whitespace
      const ahr999WithWhitespace = addFutureWhitespace(ahr999Data, lastDate, 180);
      series.ahr999 = chart.addLineSeries({
        color: '#3b82f6',
        lineWidth: 2,
        priceScaleId: 'right',
        priceFormat: { type: 'price', precision: 4, minMove: 0.0001 },
        lastValueVisible: false,
        priceLineVisible: false,
      });
      series.ahr999.setData(ahr999WithWhitespace);

      // Threshold lines
      createThresholdLine(series.ahr999, 0.45, '#22c55e');
      createThresholdLine(series.ahr999, 1.2, '#ef4444');

      // Price Series (left axis, hidden)
      series.price = chart.addLineSeries({
        color: '#f59e0b',
        lineWidth: 1.5,
        priceScaleId: 'left',
        priceFormat: { type: 'price', precision: 0, minMove: 1 },
        lastValueVisible: false,
        priceLineVisible: false,
        visible: false,
      });
      series.price.setData(priceData);

      // 200d Cost Series (left axis, hidden)
      series.cost = chart.addLineSeries({
        color: '#a855f7',
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        priceScaleId: 'left',
        priceFormat: { type: 'price', precision: 0, minMove: 1 },
        lastValueVisible: false,
        priceLineVisible: false,
        visible: false,
      });
      series.cost.setData(costData);

      // Fitted Price Series (left axis, hidden)
      series.fitted = chart.addLineSeries({
        color: '#06b6d4',
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        priceScaleId: 'left',
        priceFormat: { type: 'price', precision: 0, minMove: 1 },
        lastValueVisible: false,
        priceLineVisible: false,
        visible: false,
      });
      series.fitted.setData(fittedData);

      // Configure scales
      chart.priceScale('left').applyOptions({
        visible: true,
        mode: LightweightCharts.PriceScaleMode.Logarithmic,
      });
      chart.priceScale('right').applyOptions({
        mode: LightweightCharts.PriceScaleMode.Logarithmic,
      });

      // Default range
      defaultRange = setDefaultRange(chart, firstDate, lastDate);

      // Double-click reset
      document.getElementById('chart-container').addEventListener('dblclick', resetChart);

      // Tooltip
      setupTooltip(chart, historyData, {
        seriesVisible,
        dateElementId: 'tooltip-date',
        fields: [
          { key: 'ahr999', dataKey: 'ahr999', format: v => v.toFixed(4) },
          { key: 'price', dataKey: 'close', format: v => '$' + v.toLocaleString() },
          { key: 'cost', dataKey: 'cost_200d', format: v => '$' + v.toLocaleString() },
          { key: 'fitted', dataKey: 'fitted_price', format: v => '$' + v.toLocaleString() },
        ],
      });
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', () => {
      LangUtils.init();
      loadData();
    });
  </script>
</body>
</html>
