<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protocol â€” TEV Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #111113;
      --bg-tertiary: #18181b;
      --bg-hover: #1f1f23;
      --border: #27272a;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --accent: #22c55e;
      --accent-dim: rgba(34, 197, 94, 0.15);
      --red: #ef4444;
      --red-dim: rgba(239, 68, 68, 0.15);
      --blue: #3b82f6;
      --warning: #f59e0b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

    header {
      border-bottom: 1px solid var(--border);
      padding: 20px 0;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--bg-primary);
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
    }

    .logo-text span {
      color: var(--text-tertiary);
      font-weight: 400;
    }

    .breadcrumb {
      padding: 24px 0;
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .breadcrumb a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    .breadcrumb a:hover {
      color: var(--text-primary);
    }

    .protocol-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 32px;
    }

    .protocol-title {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .protocol-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .protocol-name {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .protocol-ticker {
      font-size: 14px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .protocol-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 12px;
    }

    .badge-high {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .badge-medium {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .tev-highlight {
      text-align: right;
    }

    .tev-value {
      font-size: 48px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent);
    }

    .tev-label {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      margin-top: 4px;
    }

    .stat-change {
      font-size: 12px;
      margin-top: 4px;
    }

    .stat-change.positive { color: var(--accent); }
    .stat-change.negative { color: var(--red); }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chart-subtitle {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-bottom: 20px;
    }

    .chart-container {
      height: 280px;
      position: relative;
    }

    .range-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .range-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .range-btn:hover {
      border-color: var(--text-tertiary);
    }

    .range-btn.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }

    .info-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .info-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-label {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .info-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
    }

    footer {
      padding: 24px 0;
      border-top: 1px solid var(--border);
      margin-top: 32px;
    }

    .footer-text {
      font-size: 13px;
      color: var(--text-tertiary);
      text-align: center;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .info-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .protocol-header { flex-direction: column; gap: 24px; }
      .tev-highlight { text-align: left; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">
          <div class="logo-icon">T</div>
          <div class="logo-text">TEV <span>Dashboard</span></div>
        </a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="breadcrumb">
      <a href="index.html">Dashboard</a> / <span id="breadcrumb-name">Loading...</span>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>Loading protocol data...</div>
    </div>

    <div id="content" style="display: none;">
      <div class="protocol-header">
        <div class="protocol-title">
          <div class="protocol-icon" id="protocol-icon">ðŸ”®</div>
          <div>
            <div class="protocol-name" id="protocol-name">Pendle</div>
            <div class="protocol-ticker" id="protocol-ticker">PENDLE</div>
          </div>
          <span class="protocol-badge badge-high" id="protocol-badge">
            <span>âœ“</span> High Confidence
          </span>
        </div>
        <div class="tev-highlight">
          <div class="tev-value" id="tev-yield">â€”%</div>
          <div class="tev-label">TEV Yield (30d Rolling)</div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Market Cap</div>
          <div class="stat-value" id="stat-mcap">â€”</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Price</div>
          <div class="stat-value" id="stat-price">â€”</div>
          <div class="stat-change" id="stat-price-change"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">30d Fees</div>
          <div class="stat-value" id="stat-fees">â€”</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">30d TEV</div>
          <div class="stat-value" id="stat-tev">â€”</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">TEV Yield History</div>
          <div class="chart-subtitle">Rolling 30-day annualized TEV Ã· Market Cap</div>
          <div class="range-selector">
            <button class="range-btn" data-range="30">30D</button>
            <button class="range-btn active" data-range="90">90D</button>
            <button class="range-btn" data-range="180">180D</button>
            <button class="range-btn" data-range="365">1Y</button>
          </div>
          <div class="chart-container">
            <canvas id="tevYieldChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Price vs TEV Yield</div>
          <div class="chart-subtitle">Correlation between token price and yield</div>
          <div class="range-selector">
            <button class="range-btn" data-range="30">30D</button>
            <button class="range-btn active" data-range="90">90D</button>
            <button class="range-btn" data-range="180">180D</button>
            <button class="range-btn" data-range="365">1Y</button>
          </div>
          <div class="chart-container">
            <canvas id="priceYieldChart"></canvas>
          </div>
        </div>
      </div>

      <div class="info-section">
        <div class="info-title">Protocol Information</div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Category</span>
            <span class="info-value" id="info-category">â€”</span>
          </div>
          <div class="info-item">
            <span class="info-label">TEV Distribution Ratio</span>
            <span class="info-value" id="info-tev-ratio">â€”</span>
          </div>
          <div class="info-item">
            <span class="info-label">Data Start Date</span>
            <span class="info-value" id="info-start-date">â€”</span>
          </div>
          <div class="info-item">
            <span class="info-label">Total Data Days</span>
            <span class="info-value" id="info-total-days">â€”</span>
          </div>
          <div class="info-item">
            <span class="info-label">Last Updated</span>
            <span class="info-value" id="info-updated">â€”</span>
          </div>
          <div class="info-item">
            <span class="info-label">Data Source</span>
            <span class="info-value">DefiLlama + CoinGecko</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-text">
        TEV Dashboard Â· Data from DefiLlama & CoinGecko
      </div>
    </div>
  </footer>

  <script>
    // Protocol configurations
    const PROTOCOLS = {
      aave: { name: 'Aave', ticker: 'AAVE', icon: 'ðŸ‘»', category: 'Lending', confidence: 'high', tevRatio: 0.318 },
      pendle: { name: 'Pendle', ticker: 'PENDLE', icon: 'ðŸ”®', category: 'Yield Tokenization', confidence: 'high', tevRatio: 0.80 },
      sky: { name: 'Sky', ticker: 'MKR', icon: 'â˜ï¸', category: 'Lending/Stablecoin', confidence: 'high', tevRatio: 0.70 },
      uniswap: { name: 'Uniswap', ticker: 'UNI', icon: 'ðŸ¦„', category: 'DEX', confidence: 'medium', tevRatio: 0.0 },
    };

    let allRecords = [];
    let tevYieldChart = null;
    let priceYieldChart = null;

    // Get protocol ID from URL
    function getProtocolId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id') || 'pendle';
    }

    // Utility functions
    function formatCurrency(value) {
      if (value === null || value === undefined) return 'â€”';
      if (value >= 1e9) return '$' + (value / 1e9).toFixed(2) + 'B';
      if (value >= 1e6) return '$' + (value / 1e6).toFixed(2) + 'M';
      if (value >= 1e3) return '$' + (value / 1e3).toFixed(1) + 'K';
      return '$' + value.toFixed(0);
    }

    function formatPrice(value) {
      if (value === null || value === undefined) return 'â€”';
      if (value >= 100) return '$' + value.toFixed(0);
      if (value >= 1) return '$' + value.toFixed(2);
      return '$' + value.toFixed(4);
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return 'â€”';
      return (value * 100).toFixed(2) + '%';
    }

    // Load historical records
    async function loadHistoricalRecords(protocolId) {
      const records = [];
      const now = new Date();
      
      // Load last 24 months of data
      for (let i = 0; i < 24; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const month = date.toISOString().slice(0, 7);
        
        try {
          const response = await fetch(`../data/daily/${protocolId}/${month}.json`);
          if (response.ok) {
            const data = await response.json();
            records.push(...(data.records || []));
          }
        } catch (e) {
          // Skip missing months
        }
      }
      
      // Sort by date and dedupe
      records.sort((a, b) => a.date.localeCompare(b.date));
      return records;
    }

    // Calculate TEV yield for each day (30-day rolling)
    function calculateTevYields(records) {
      const yields = [];
      
      for (let i = 29; i < records.length; i++) {
        const window = records.slice(i - 29, i + 1);
        const totalTev = window.reduce((sum, r) => sum + (r.daily_tev_usd || 0), 0);
        const annualizedTev = totalTev * 12;
        const mcap = records[i].market_cap_usd;
        
        if (mcap && mcap > 0) {
          yields.push({
            date: records[i].date,
            price: records[i].price_usd,
            market_cap: mcap,
            tev_yield: annualizedTev / mcap,
            daily_fees: records[i].daily_fees_usd,
            daily_tev: records[i].daily_tev_usd,
          });
        }
      }
      
      return yields;
    }

    // Render charts
    function renderCharts(yields, range = 90) {
      const filtered = yields.slice(-range);
      const dates = filtered.map(y => y.date.slice(5)); // MM-DD
      const tevYields = filtered.map(y => (y.tev_yield * 100).toFixed(2));
      const prices = filtered.map(y => y.price?.toFixed(2));
      
      const avgYield = (tevYields.reduce((a, b) => a + parseFloat(b), 0) / tevYields.length).toFixed(2);

      // Destroy existing charts
      if (tevYieldChart) tevYieldChart.destroy();
      if (priceYieldChart) priceYieldChart.destroy();

      // TEV Yield Chart
      const ctx1 = document.getElementById('tevYieldChart').getContext('2d');
      tevYieldChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'TEV Yield',
              data: tevYields,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 4,
            },
            {
              label: 'Average',
              data: Array(dates.length).fill(avgYield),
              borderColor: '#71717a',
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#18181b',
              borderColor: '#27272a',
              borderWidth: 1,
              titleColor: '#fafafa',
              bodyColor: '#a1a1aa',
              padding: 12,
              displayColors: false,
              callbacks: { label: (ctx) => `TEV Yield: ${ctx.raw}%` }
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#71717a', maxTicksLimit: 8 } },
            y: { grid: { color: '#27272a' }, ticks: { color: '#71717a', callback: (v) => v + '%' } }
          }
        }
      });

      // Price vs Yield Chart
      const ctx2 = document.getElementById('priceYieldChart').getContext('2d');
      priceYieldChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Price',
              data: prices,
              borderColor: '#3b82f6',
              backgroundColor: 'transparent',
              tension: 0.4,
              pointRadius: 0,
              yAxisID: 'y',
            },
            {
              label: 'TEV Yield',
              data: tevYields,
              borderColor: '#22c55e',
              backgroundColor: 'transparent',
              tension: 0.4,
              pointRadius: 0,
              yAxisID: 'y1',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: {
              position: 'top',
              align: 'end',
              labels: { color: '#a1a1aa', usePointStyle: true, pointStyle: 'line' }
            },
            tooltip: {
              backgroundColor: '#18181b',
              borderColor: '#27272a',
              borderWidth: 1,
              titleColor: '#fafafa',
              bodyColor: '#a1a1aa',
              padding: 12,
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#71717a', maxTicksLimit: 8 } },
            y: {
              position: 'left',
              grid: { color: '#27272a' },
              ticks: { color: '#3b82f6', callback: (v) => '$' + v }
            },
            y1: {
              position: 'right',
              grid: { display: false },
              ticks: { color: '#22c55e', callback: (v) => v + '%' }
            }
          }
        }
      });
    }

    // Initialize
    async function init() {
      const protocolId = getProtocolId();
      const config = PROTOCOLS[protocolId];
      
      if (!config) {
        document.getElementById('loading').innerHTML = '<div style="color: #ef4444;">Protocol not found</div>';
        return;
      }

      // Update page title
      document.title = `${config.name} â€” TEV Dashboard`;
      document.getElementById('breadcrumb-name').textContent = config.name;

      try {
        // Load latest summary
        const summaryResponse = await fetch(`../data/daily/${protocolId}/latest.json`);
        const summary = await summaryResponse.json();

        // Load historical records
        allRecords = await loadHistoricalRecords(protocolId);
        const yields = calculateTevYields(allRecords);

        // Calculate 30d totals
        const last30 = allRecords.slice(-30);
        const totalFees = last30.reduce((sum, r) => sum + (r.daily_fees_usd || 0), 0);
        const totalTev = last30.reduce((sum, r) => sum + (r.daily_tev_usd || 0), 0);

        // Update UI
        document.getElementById('protocol-icon').textContent = config.icon;
        document.getElementById('protocol-name').textContent = config.name;
        document.getElementById('protocol-ticker').textContent = config.ticker;
        
        const badge = document.getElementById('protocol-badge');
        badge.className = `protocol-badge badge-${config.confidence}`;
        badge.innerHTML = `<span>${config.confidence === 'high' ? 'âœ“' : '!'}</span> ${config.confidence.charAt(0).toUpperCase() + config.confidence.slice(1)} Confidence`;

        const latestYield = yields.length > 0 ? yields[yields.length - 1].tev_yield : null;
        document.getElementById('tev-yield').textContent = latestYield ? (latestYield * 100).toFixed(2) + '%' : 'â€”';

        document.getElementById('stat-mcap').textContent = formatCurrency(summary.latest_record?.market_cap_usd);
        document.getElementById('stat-price').textContent = formatPrice(summary.latest_record?.price_usd);
        document.getElementById('stat-fees').textContent = formatCurrency(totalFees);
        document.getElementById('stat-tev').textContent = formatCurrency(totalTev);

        document.getElementById('info-category').textContent = config.category;
        document.getElementById('info-tev-ratio').textContent = (config.tevRatio * 100).toFixed(0) + '%';
        document.getElementById('info-start-date').textContent = summary.data_range?.start || 'â€”';
        document.getElementById('info-total-days').textContent = summary.data_range?.total_days || 'â€”';
        document.getElementById('info-updated').textContent = summary.updated_at ? new Date(summary.updated_at).toLocaleDateString() : 'â€”';

        // Hide loading, show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Render charts
        if (yields.length > 0) {
          renderCharts(yields, 90);
        }

        // Setup range selector
        document.querySelectorAll('.range-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const parent = btn.parentElement;
            parent.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCharts(yields, parseInt(btn.dataset.range));
          });
        });

      } catch (error) {
        console.error('Failed to load protocol data:', error);
        document.getElementById('loading').innerHTML = `
          <div style="color: #ef4444;">Failed to load data</div>
          <div style="margin-top: 8px; font-size: 12px;">${error.message}</div>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
