<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>MVRV 指标 — Crypto3D</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <script src="../indicators/js/chart-utils.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo">
          <img src="../logo.svg" alt="3D" class="logo-icon">
          <span class="logo-text">Crypto3D</span>
        </a>
        <div class="nav-links">
          <a href="../" data-zh="首页" data-en="Home">首页</a>
          <div class="lang-switch" onclick="LangUtils.toggle(); updateDisplay();">
            <span id="lang-zh" class="active">中文</span>
            <span>/</span>
            <span id="lang-en">EN</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">MVRV <span data-zh="指标" data-en="Ratio">指标</span></h1>
        <p class="page-subtitle" data-zh="市值与实现价值比率 — 比特币周期顶底判断" data-en="Market Value to Realized Value — Bitcoin cycle top/bottom indicator">市值与实现价值比率 — 比特币周期顶底判断</p>
      </div>

      <div class="data-notice" id="data-notice" style="display: none;">
        ⚠️ <span data-zh="当前使用模拟数据，真实数据接入中..." data-en="Currently using simulated data, real data integration pending...">当前使用模拟数据，真实数据接入中...</span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label" data-zh="当前 MVRV" data-en="Current MVRV">当前 MVRV</div>
          <div class="stat-value" id="current-value">—</div>
          <div class="stat-hint" id="current-zone">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="市场状态" data-en="Market State">市场状态</div>
          <div class="stat-value" id="market-state" style="font-size: 18px;">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="历史分位" data-en="Historical Percentile">历史分位</div>
          <div class="stat-value" id="percentile" style="color: var(--blue)">—</div>
          <div class="stat-hint" data-zh="相对历史位置" data-en="Relative to history">相对历史位置</div>
        </div>
      </div>

      <div class="zone-legend">
        <div class="zone-item">
          <div class="zone-dot undervalued"></div>
          <span data-zh="< 1.0 低估" data-en="< 1.0 Undervalued">< 1.0 低估</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot fair"></div>
          <span data-zh="1.0 ~ 3.0 合理" data-en="1.0 ~ 3.0 Fair Value">1.0 ~ 3.0 合理</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot overvalued"></div>
          <span data-zh="> 3.0 高估" data-en="> 3.0 Overvalued">> 3.0 高估</span>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title" data-zh="MVRV 历史走势" data-en="MVRV History">MVRV 历史走势</div>
          <div class="chart-legend">
            <div class="legend-item scale-toggle" onclick="toggleScale()" title="切换线性/对数坐标">
              <span id="scale-label">Log</span>
            </div>
            <div class="legend-item fixed" title="阈值线始终显示">
              <div class="legend-line dashed" style="color: #ef4444;"></div>
              <span>3.0</span>
            </div>
            <div class="legend-item fixed" title="阈值线始终显示">
              <div class="legend-line dashed" style="color: #22c55e;"></div>
              <span>1.0</span>
            </div>
            <div class="legend-item" data-series="mvrv" onclick="toggleSeries('mvrv')">
              <div class="legend-line" style="background: #a855f7;"></div>
              <span>MVRV</span>
            </div>
            <div class="legend-item disabled" data-series="btc" onclick="toggleSeries('btc')">
              <div class="legend-line" style="background: #f59e0b;"></div>
              <span>BTC</span>
            </div>
          </div>
        </div>
        <div class="chart-wrapper" id="chart-container"></div>
        <div class="chart-tooltip" id="chart-tooltip">
          <div class="tooltip-date" id="tooltip-date">—</div>
          <div class="tooltip-item" id="tooltip-mvrv" style="display: none;">
            <div class="tooltip-dot" style="background: #a855f7;"></div>
            <span class="tooltip-label">MVRV:</span>
            <span class="tooltip-value" id="tooltip-mvrv-value">—</span>
          </div>
          <div class="tooltip-item" id="tooltip-btc" style="display: none;">
            <div class="tooltip-dot" style="background: #f59e0b;"></div>
            <span class="tooltip-label">BTC:</span>
            <span class="tooltip-value" id="tooltip-btc-value">—</span>
          </div>
        </div>
        <div class="chart-hint" data-zh="💡 拖动平移 · 滚轮缩放 · 双击重置" data-en="💡 Drag to pan · Scroll to zoom · Double-click to reset">💡 拖动平移 · 滚轮缩放 · 双击重置</div>
      </div>
      <div class="data-update-time" id="data-update-time" data-zh="数据更新: —" data-en="Data updated: —">数据更新: —</div>

      <div class="info-section">
        <h2 class="info-title" data-zh="指标说明" data-en="About MVRV">指标说明</h2>
        <div class="info-text">
          <p data-zh="MVRV（Market Value to Realized Value）是衡量比特币市值与实现市值之间关系的指标，用于判断市场周期的顶部和底部。" 
             data-en="MVRV (Market Value to Realized Value) measures the relationship between Bitcoin's market cap and realized cap, used to identify market cycle tops and bottoms.">
            MVRV（Market Value to Realized Value）是衡量比特币市值与实现市值之间关系的指标，用于判断市场周期的顶部和底部。
          </p>
          <div class="formula">MVRV = 流通市值 (Market Cap) / 实现市值 (Realized Cap)</div>
          <p data-zh="• 实现市值：按每个 UTXO 最后移动时的价格计算的市值总和" 
             data-en="• Realized Cap: Sum of all UTXOs valued at the price when they last moved">
            • 实现市值：按每个 UTXO 最后移动时的价格计算的市值总和
          </p>
          <p data-zh="• MVRV < 1：市场处于低估状态，大部分持有者亏损" 
             data-en="• MVRV < 1: Market is undervalued, most holders are at a loss">
            • MVRV < 1：市场处于低估状态，大部分持有者亏损
          </p>
          <p data-zh="• MVRV > 3：市场可能过热，历史上接近周期顶部" 
             data-en="• MVRV > 3: Market may be overheated, historically near cycle tops">
            • MVRV > 3：市场可能过热，历史上接近周期顶部
          </p>
          <div class="disclaimer" 
               data-zh="⚠️ 没有永远有效的指标。MVRV 是基于链上数据的统计指标，在新的市场环境下可能存在一定局限性，请酌情参考，理性决策。"
               data-en="⚠️ No indicator is forever effective. MVRV is an on-chain statistical indicator that may have limitations. Please use it as a reference.">
            ⚠️ 没有永远有效的指标。MVRV 是基于链上数据的统计指标，在新的市场环境下可能存在一定局限性，请酌情参考，理性决策。
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="footer-text">© 2026 Crypto3D</p>
    </div>
  </footer>

  <script>
    // === State ===
    let chart = null;
    let series = {};
    let zones = {};
    let seriesVisible = { mvrv: true, btc: false };
    let isLogScale = true;
    let defaultRange = null;
    let historyData = {};
    let currentData = null;

    // === MVRV Zone Logic ===
    function getZoneInfo(value) {
      const lang = LangUtils.get();
      if (value < 1.0) {
        return { 
          class: 'undervalued', 
          zone: lang === 'zh' ? '低估区' : 'Undervalued',
          state: lang === 'zh' ? '🟢 低估' : '🟢 Undervalued'
        };
      } else if (value <= 3.0) {
        return { 
          class: 'fair', 
          zone: lang === 'zh' ? '合理区' : 'Fair Value',
          state: lang === 'zh' ? '🟡 合理' : '🟡 Fair'
        };
      } else {
        return { 
          class: 'overvalued', 
          zone: lang === 'zh' ? '高估区' : 'Overvalued',
          state: lang === 'zh' ? '🔴 高估' : '🔴 Overvalued'
        };
      }
    }

    function calculatePercentile(value, history) {
      const sorted = [...history.map(d => d.mvrv)].sort((a, b) => a - b);
      const index = sorted.findIndex(v => v >= value);
      return Math.round((index / sorted.length) * 100);
    }

    // === Chart Controls ===
    function toggleSeries(name) {
      toggleSeriesVisibility(series, seriesVisible, name, { mvrv: zones });
      if (name === 'btc' && chart) {
        chart.priceScale('left').applyOptions({ visible: seriesVisible[name] });
      }
      // Update tooltip visibility
      const el = document.getElementById(`tooltip-${name}`);
      if (el) el.style.display = seriesVisible[name] ? 'flex' : 'none';
    }

    function toggleScale() {
      isLogScale = toggleScaleMode(chart, isLogScale, 'scale-label', ['right']);
    }

    function resetChart() {
      if (chart && defaultRange) chart.timeScale().setVisibleRange(defaultRange);
    }

    // === Display Update ===
    function updateDisplay() {
      if (!currentData) return;
      const current = currentData.current;
      const zoneInfo = getZoneInfo(current.value);
      const percentile = calculatePercentile(current.value, currentData.history);

      document.getElementById('current-value').textContent = current.value.toFixed(2);
      document.getElementById('current-value').className = `stat-value ${zoneInfo.class}`;
      document.getElementById('current-zone').textContent = zoneInfo.zone;
      document.getElementById('market-state').textContent = zoneInfo.state;
      document.getElementById('percentile').textContent = percentile + '%';

      if (currentData.updated_at) {
        const prefix = LangUtils.get() === 'zh' ? '数据更新: ' : 'Data updated: ';
        document.getElementById('data-update-time').textContent = prefix + currentData.updated_at;
      }
    }

    // === Data Loading ===
    async function loadData() {
      try {
        const res = await fetch('../indicators/data/mvrv.json');
        currentData = await res.json();

        if (currentData.note && currentData.note.includes('Simulated')) {
          document.getElementById('data-notice').style.display = 'block';
        }

        updateDisplay();
        drawChart(currentData.history);
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    // === Chart Drawing ===
    function drawChart(history) {
      chart = createChart('chart-container', {
        crosshair: {
          vertLine: { color: 'rgba(168, 85, 247, 0.5)', labelBackgroundColor: '#a855f7' },
          horzLine: { color: 'rgba(168, 85, 247, 0.5)', labelBackgroundColor: '#a855f7' },
        },
      });

      // Build data
      const mvrvData = history.map(d => ({ time: d.date, value: d.mvrv }));
      const btcData = history.filter(d => d.btc_price).map(d => ({ time: d.date, value: d.btc_price }));
      historyData = buildHistoryLookup(history);
      const lastDate = history[history.length - 1].date;

      // Zone backgrounds
      zones.green = createZoneSeries(chart, 1.0, {
        bottomFill1: 'rgba(34, 197, 94, 0.08)',
        bottomFill2: 'rgba(34, 197, 94, 0.25)',
      });
      zones.green.setData(mvrvData);

      zones.red = createZoneSeries(chart, 3.0, {
        topFill1: 'rgba(239, 68, 68, 0.08)',
        topFill2: 'rgba(239, 68, 68, 0.25)',
      });
      zones.red.setData(mvrvData);

      // MVRV Series
      const mvrvWithWhitespace = addFutureWhitespace(mvrvData, lastDate, 180);
      series.mvrv = chart.addLineSeries({
        color: '#a855f7',
        lineWidth: 2,
        priceScaleId: 'right',
        priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
        lastValueVisible: false,
        priceLineVisible: false,
      });
      series.mvrv.setData(mvrvWithWhitespace);

      // Threshold lines
      createThresholdLine(series.mvrv, 1.0, '#22c55e');
      createThresholdLine(series.mvrv, 3.0, '#ef4444');

      // BTC Price Series (hidden by default)
      series.btc = chart.addLineSeries({
        color: '#f59e0b',
        lineWidth: 2,
        priceScaleId: 'left',
        priceFormat: { type: 'price', precision: 0, minMove: 1 },
        lastValueVisible: false,
        priceLineVisible: false,
        visible: false,
      });
      series.btc.setData(btcData);

      // Configure left scale
      chart.priceScale('left').applyOptions({
        visible: false,
        mode: LightweightCharts.PriceScaleMode.Logarithmic,
      });
      chart.priceScale('right').applyOptions({
        mode: LightweightCharts.PriceScaleMode.Logarithmic,
      });

      // Default range from 2014
      defaultRange = setDefaultRange(chart, '2014-01-01', lastDate);

      // Double-click reset
      document.getElementById('chart-container').addEventListener('dblclick', resetChart);

      // Tooltip
      setupTooltip(chart, historyData, {
        seriesVisible,
        dateElementId: 'tooltip-date',
        fields: [
          { key: 'mvrv', dataKey: 'mvrv', format: v => v.toFixed(2) },
          { key: 'btc', dataKey: 'btc_price', format: v => '$' + v.toLocaleString() },
        ],
      });
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', () => {
      LangUtils.init();
      loadData();
    });
  </script>
</body>
</html>
