<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>BTC Dominance â€” Crypto3D</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <script src="../indicators/js/chart-utils.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo">
          <img src="../logo.svg" alt="3D" class="logo-icon">
          <span class="logo-text">Crypto3D</span>
        </a>
        <div class="nav-links">
          <a href="../" data-zh="é¦–é¡µ" data-en="Home">é¦–é¡µ</a>
          <a href="../ahr999/">AHR999</a>
          <a href="../bmri/">BMRI</a>
          <div class="lang-switch" onclick="LangUtils.toggle(); updateDisplay();">
            <span id="lang-zh" class="active">ä¸­æ–‡</span>
            <span>/</span>
            <span id="lang-en">EN</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">BTC Dominance <span data-zh="æ¯”ç‰¹å¸å¸‚å€¼å æ¯”" data-en="Bitcoin Dominance">æ¯”ç‰¹å¸å¸‚å€¼å æ¯”</span></h1>
        <p class="page-subtitle" data-zh="æ¯”ç‰¹å¸å¸‚å€¼å åŠ å¯†æ€»å¸‚å€¼çš„æ¯”ä¾‹ï¼Œåˆ¤æ–­å¸‚åœºèµ„é‡‘æµå‘" data-en="Bitcoin's share of total crypto market cap, indicating capital flow">æ¯”ç‰¹å¸å¸‚å€¼å åŠ å¯†æ€»å¸‚å€¼çš„æ¯”ä¾‹ï¼Œåˆ¤æ–­å¸‚åœºèµ„é‡‘æµå‘</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label" data-zh="å½“å‰å æ¯”" data-en="Current">å½“å‰å æ¯”</div>
          <div class="stat-value" id="current-value">â€”</div>
          <div class="stat-hint" id="current-zone">â€”</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="å¸‚åœºçŠ¶æ€" data-en="Market State">å¸‚åœºçŠ¶æ€</div>
          <div class="stat-value" id="market-state" style="font-size: 18px;">â€”</div>
          <div class="stat-hint" id="zone-hint">â€”</div>
        </div>
      </div>

      <div class="zone-legend">
        <div class="zone-item">
          <div class="zone-dot btc-dominant"></div>
          <span data-zh="> 60% BTCä¸»å¯¼" data-en="> 60% BTC Dominant">> 60% BTCä¸»å¯¼</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot balanced"></div>
          <span data-zh="40-60% å‡è¡¡" data-en="40-60% Balanced">40-60% å‡è¡¡</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot alt-season"></div>
          <span data-zh="< 40% å±±å¯¨å­£" data-en="< 40% Alt Season">< 40% å±±å¯¨å­£</span>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title" data-zh="BTC Dominance å†å²èµ°åŠ¿" data-en="BTC Dominance History">BTC Dominance å†å²èµ°åŠ¿</div>
          <div class="chart-legend">
            <div class="legend-item scale-toggle" onclick="toggleScale()" title="åˆ‡æ¢çº¿æ€§/å¯¹æ•°åæ ‡">
              <span id="scale-label">Log</span>
            </div>
            <div class="legend-item fixed">
              <div class="legend-line dashed" style="color: #f59e0b;"></div>
              <span>60%</span>
            </div>
            <div class="legend-item fixed">
              <div class="legend-line dashed" style="color: #a855f7;"></div>
              <span>40%</span>
            </div>
            <div class="legend-item">
              <div class="legend-line" style="background: #3b82f6;"></div>
              <span>BTC.D</span>
            </div>
            <div class="legend-item disabled" data-series="btcPrice" onclick="toggleSeries('btcPrice')">
              <div class="legend-line" style="background: #f59e0b;"></div>
              <span data-zh="BTCä»·æ ¼" data-en="BTC Price">BTCä»·æ ¼</span>
            </div>
          </div>
        </div>
        <div class="chart-wrapper" id="chart-container"></div>
        <div class="chart-tooltip floating" id="chart-tooltip">
          <div class="tooltip-date" id="tooltip-date">â€”</div>
          <div class="tooltip-item">
            <div class="tooltip-dot" style="background: #3b82f6;"></div>
            <span class="tooltip-label">BTC.D:</span>
            <span class="tooltip-value" id="tooltip-value">â€”</span>
          </div>
          <div class="tooltip-item" id="tooltip-btcPrice" style="display:none;">
            <div class="tooltip-dot" style="background: #f59e0b;"></div>
            <span class="tooltip-label">BTC:</span>
            <span class="tooltip-value" id="tooltip-btcPrice-value">â€”</span>
          </div>
        </div>
        <div class="chart-hint" data-zh="ğŸ’¡ æ‹–åŠ¨å¹³ç§» Â· æ»šè½®ç¼©æ”¾ Â· åŒå‡»é‡ç½®" data-en="ğŸ’¡ Drag to pan Â· Scroll to zoom Â· Double-click to reset">ğŸ’¡ æ‹–åŠ¨å¹³ç§» Â· æ»šè½®ç¼©æ”¾ Â· åŒå‡»é‡ç½®</div>
      </div>
      <div class="data-update-time" id="data-update-time" data-zh="æ•°æ®æ›´æ–°: â€”" data-en="Data updated: â€”">æ•°æ®æ›´æ–°: â€”</div>

      <div class="info-section">
        <h2 class="info-title" data-zh="æŒ‡æ ‡è¯´æ˜" data-en="About BTC Dominance">æŒ‡æ ‡è¯´æ˜</h2>
        <div class="info-text">
          <p data-zh="BTC Dominanceï¼ˆæ¯”ç‰¹å¸å¸‚å€¼å æ¯”ï¼‰æ˜¯æ¯”ç‰¹å¸å¸‚å€¼å æ•´ä¸ªåŠ å¯†è´§å¸å¸‚åœºæ€»å¸‚å€¼çš„ç™¾åˆ†æ¯”ã€‚" 
             data-en="BTC Dominance is the percentage of Bitcoin's market cap relative to the total cryptocurrency market cap.">
            BTC Dominanceï¼ˆæ¯”ç‰¹å¸å¸‚å€¼å æ¯”ï¼‰æ˜¯æ¯”ç‰¹å¸å¸‚å€¼å æ•´ä¸ªåŠ å¯†è´§å¸å¸‚åœºæ€»å¸‚å€¼çš„ç™¾åˆ†æ¯”ã€‚
          </p>
          <p data-zh="â€¢ é«˜å æ¯” (>60%)ï¼šå¸‚åœºåå‘é¿é™©ï¼Œèµ„é‡‘é›†ä¸­åœ¨ BTCï¼Œå±±å¯¨å¸è¡¨ç°è¾ƒå¼±" 
             data-en="â€¢ High (>60%): Risk-off sentiment, capital concentrated in BTC, altcoins underperform">
            â€¢ é«˜å æ¯” (>60%)ï¼šå¸‚åœºåå‘é¿é™©ï¼Œèµ„é‡‘é›†ä¸­åœ¨ BTCï¼Œå±±å¯¨å¸è¡¨ç°è¾ƒå¼±
          </p>
          <p data-zh="â€¢ å‡è¡¡åŒºé—´ (40-60%)ï¼šå¸‚åœºç›¸å¯¹å‡è¡¡ï¼ŒBTC å’Œå±±å¯¨å¸å…±åŒå‘å±•" 
             data-en="â€¢ Balanced (40-60%): Market equilibrium, both BTC and altcoins developing">
            â€¢ å‡è¡¡åŒºé—´ (40-60%)ï¼šå¸‚åœºç›¸å¯¹å‡è¡¡ï¼ŒBTC å’Œå±±å¯¨å¸å…±åŒå‘å±•
          </p>
          <p data-zh="â€¢ ä½å æ¯” (<40%)ï¼šå±±å¯¨å­£ï¼Œèµ„é‡‘å¤§é‡æµå…¥å±±å¯¨å¸ï¼Œé€šå¸¸å‡ºç°åœ¨ç‰›å¸‚åæœŸ" 
             data-en="â€¢ Low (<40%): Alt season, capital flowing into altcoins, typically late bull market">
            â€¢ ä½å æ¯” (<40%)ï¼šå±±å¯¨å­£ï¼Œèµ„é‡‘å¤§é‡æµå…¥å±±å¯¨å¸ï¼Œé€šå¸¸å‡ºç°åœ¨ç‰›å¸‚åæœŸ
          </p>
          <div class="disclaimer" 
               data-zh="âš ï¸ BTC Dominance å—ç¨³å®šå¸å¸‚å€¼å½±å“è¾ƒå¤§ã€‚è¿‘å¹´æ¥ç¨³å®šå¸å¸‚å€¼å¢é•¿è¿…é€Ÿï¼Œå¯¼è‡´ BTC.D æ•´ä½“ä¸‹ç§»ï¼Œéœ€ç»“åˆå…¶ä»–æŒ‡æ ‡ç»¼åˆåˆ¤æ–­ã€‚"
               data-en="âš ï¸ BTC Dominance is significantly affected by stablecoin market cap. Recent stablecoin growth has pushed BTC.D lower overall. Use with other indicators.">
            âš ï¸ BTC Dominance å—ç¨³å®šå¸å¸‚å€¼å½±å“è¾ƒå¤§ã€‚è¿‘å¹´æ¥ç¨³å®šå¸å¸‚å€¼å¢é•¿è¿…é€Ÿï¼Œå¯¼è‡´ BTC.D æ•´ä½“ä¸‹ç§»ï¼Œéœ€ç»“åˆå…¶ä»–æŒ‡æ ‡ç»¼åˆåˆ¤æ–­ã€‚
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="footer-text">Â© 2026 Crypto3D</p>
    </div>
  </footer>

  <script>
    // === State ===
    let chart = null;
    let series = {};
    let defaultRange = null;
    let historyData = {};
    let currentData = null;
    let seriesVisible = { btcDominance: true, btcPrice: false };
    let isLogScale = true;
    let btcPriceData = null;

    // === BTC.D Zone Logic ===
    function getZoneInfo(value) {
      const lang = LangUtils.get();
      if (value >= 60) {
        return {
          class: 'btc-dominant',
          zone: lang === 'zh' ? 'BTC ä¸»å¯¼' : 'BTC Dominant',
          state: 'ğŸŸ  BTC ä¸»å¯¼',
          hint: lang === 'zh' ? 'èµ„é‡‘é›†ä¸­åœ¨ BTCï¼Œå±±å¯¨å¸å¼±åŠ¿' : 'Capital in BTC, altcoins weak'
        };
      } else if (value >= 40) {
        return {
          class: 'balanced',
          zone: lang === 'zh' ? 'å‡è¡¡å¸‚åœº' : 'Balanced',
          state: 'ğŸ”µ å‡è¡¡',
          hint: lang === 'zh' ? 'å¸‚åœºç›¸å¯¹å‡è¡¡' : 'Market balanced'
        };
      } else {
        return {
          class: 'alt-season',
          zone: lang === 'zh' ? 'å±±å¯¨å­£' : 'Alt Season',
          state: 'ğŸŸ£ å±±å¯¨å­£',
          hint: lang === 'zh' ? 'èµ„é‡‘æµå‘å±±å¯¨å¸' : 'Capital flowing to alts'
        };
      }
    }

    // === Chart Controls ===
    function resetChart() {
      if (chart && defaultRange) chart.timeScale().setVisibleRange(defaultRange);
    }

    function toggleScale() {
      isLogScale = toggleScaleMode(chart, isLogScale, 'scale-label', ['right']);
    }

    function toggleSeries(name) {
      toggleSeriesVisibility(series, seriesVisible, name, { btcDominance: null });
      const el = document.getElementById(`tooltip-${name}`);
      if (el) el.style.display = seriesVisible[name] ? 'flex' : 'none';
      if (name === 'btcPrice' && chart) {
        chart.priceScale('left').applyOptions({ visible: seriesVisible[name] });
      }
    }

    // === Display Update ===
    function updateDisplay() {
      if (!currentData) return;
      const current = currentData.current;
      const zoneInfo = getZoneInfo(current.value);

      document.getElementById('current-value').textContent = current.value.toFixed(2) + '%';
      document.getElementById('current-value').className = `stat-value ${zoneInfo.class}`;
      document.getElementById('current-zone').textContent = zoneInfo.zone;
      document.getElementById('market-state').textContent = zoneInfo.state;
      document.getElementById('zone-hint').textContent = zoneInfo.hint;

      if (currentData.updated_at) {
        const prefix = LangUtils.get() === 'zh' ? 'æ•°æ®æ›´æ–°: ' : 'Data updated: ';
        document.getElementById('data-update-time').textContent = prefix + currentData.updated_at;
      }
    }

    // === Data Loading ===
    async function loadData() {
      console.log('[BTC-D] loadData started');
      try {
        const [dominanceRes, btcPriceRes] = await Promise.all([
          fetch('../indicators/data/btc-dominance.json'),
          fetch('../indicators/data/shared/btc-price.json').catch(() => null)
        ]);
        console.log('[BTC-D] dominanceRes:', dominanceRes.status, dominanceRes.ok);
        if (!dominanceRes.ok) throw new Error(`HTTP ${dominanceRes.status}`);
        currentData = await dominanceRes.json();
        console.log('[BTC-D] currentData keys:', Object.keys(currentData));
        if (btcPriceRes && btcPriceRes.ok) btcPriceData = await btcPriceRes.json();
        updateDisplay();
        drawChart(currentData.history);
        console.log('[BTC-D] Load complete');
      } catch (err) {
        console.error('[BTC-D] Failed to load data:', err);
        document.querySelector('.stats-grid').innerHTML = 
          `<div class="stat-card" style="grid-column: span 2; text-align: center; padding: 40px;">
            <div style="color: var(--danger); font-size: 18px;">âš ï¸ åŠ è½½å¤±è´¥</div>
            <div style="color: var(--text-tertiary); margin-top: 8px;">${err.message}</div>
          </div>`;
      }
    }

    // === Chart Drawing ===
    function drawChart(history) {
      chart = createChart('chart-container');

      // Prepare data
      const chartData = history.map(d => ({ time: d.date, value: d.value }));
      historyData = buildHistoryLookup(history);
      const lastDate = history[history.length - 1].date;

      // Add whitespace
      const dataWithWhitespace = addFutureWhitespace(chartData, lastDate, 90);

      // BTC Price series (from shared data, hidden by default)
      let btcPriceDataArr = [];
      if (btcPriceData) {
        btcPriceDataArr = history.map(d => {
          const priceRecord = btcPriceData.history.find(p => p.date === d.date);
          return { time: d.date, value: priceRecord?.price || null };
        }).filter(d => d.value !== null);
      }

      // Main series
      series.btcDominance = chart.addLineSeries({
        color: '#3b82f6',
        lineWidth: 2,
        priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
        lastValueVisible: false,
        priceLineVisible: false,
      });
      series.btcDominance.setData(dataWithWhitespace);

      // BTC Price series (hidden by default)
      series.btcPrice = chart.addLineSeries({
        color: '#f59e0b',
        lineWidth: 2,
        priceScaleId: 'left',
        priceFormat: { type: 'price', precision: 0, minMove: 1 },
        lastValueVisible: false,
        priceLineVisible: false,
        visible: false,
      });
      series.btcPrice.setData(btcPriceDataArr);

      // Configure scales
      chart.priceScale('right').applyOptions({
        mode: LightweightCharts.PriceScaleMode.Logarithmic,
      });
      chart.priceScale('left').applyOptions({
        visible: false,
        mode: LightweightCharts.PriceScaleMode.Logarithmic,
      });

      // Threshold lines
      createThresholdLine(series.btcDominance, 60, '#f59e0b');
      createThresholdLine(series.btcDominance, 40, '#a855f7');

      // Default range from 2014
      defaultRange = setDefaultRange(chart, '2014-01-01', lastDate);

      // Double-click reset
      document.getElementById('chart-container').addEventListener('dblclick', resetChart);

      // Tooltip
      const tooltip = document.getElementById('chart-tooltip');
      chart.subscribeCrosshairMove(param => {
        if (!param.time || !param.point || param.point.x < 0) {
          tooltip.classList.remove('visible');
          return;
        }
        
        const dateStr = typeof param.time === 'string' ? param.time :
          `${param.time.year}-${String(param.time.month).padStart(2, '0')}-${String(param.time.day).padStart(2, '0')}`;
        const data = historyData[dateStr];
        const priceRecord = btcPriceData?.history.find(p => p.date === dateStr);
        
        if (data) {
          document.getElementById('tooltip-date').textContent = formatTime(param.time);
          document.getElementById('tooltip-value').textContent = data.value.toFixed(2) + '%';
          tooltip.classList.add('visible');
          if (seriesVisible.btcPrice && priceRecord?.price) {
            document.getElementById('tooltip-btcPrice').style.display = 'flex';
            document.getElementById('tooltip-btcPrice-value').textContent = '$' + priceRecord.price.toLocaleString();
          } else {
            document.getElementById('tooltip-btcPrice').style.display = 'none'; }
        } else {
          tooltip.classList.remove('visible');
          document.getElementById('tooltip-btcPrice').style.display = 'none'; }
      });

      // Fit content then set default range
      chart.timeScale().fitContent();
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', () => {
      LangUtils.init();
      loadData();
    });
  </script>
</body>
</html>
