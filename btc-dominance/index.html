<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>BTC Dominance — Crypto3D</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <script src="../indicators/js/chart-utils.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo">
          <img src="../logo.svg" alt="3D" class="logo-icon">
          <span class="logo-text">Crypto3D</span>
        </a>
        <div class="nav-links">
          <a href="../" data-zh="首页" data-en="Home">首页</a>
          <a href="../ahr999/">AHR999</a>
          <a href="../bmri/">BMRI</a>
          <div class="lang-switch" onclick="LangUtils.toggle(); updateDisplay();">
            <span id="lang-zh" class="active">中文</span>
            <span>/</span>
            <span id="lang-en">EN</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">BTC Dominance <span data-zh="比特币市值占比" data-en="Bitcoin Dominance">比特币市值占比</span></h1>
        <p class="page-subtitle" data-zh="比特币市值占加密总市值的比例，判断市场资金流向" data-en="Bitcoin's share of total crypto market cap, indicating capital flow">比特币市值占加密总市值的比例，判断市场资金流向</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label" data-zh="当前占比" data-en="Current">当前占比</div>
          <div class="stat-value" id="current-value">—</div>
          <div class="stat-hint" id="current-zone">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="市场状态" data-en="Market State">市场状态</div>
          <div class="stat-value" id="market-state" style="font-size: 18px;">—</div>
          <div class="stat-hint" id="zone-hint">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label" data-zh="更新日期" data-en="Updated">更新日期</div>
          <div class="stat-value" id="update-date" style="font-size: 16px; color: var(--text-secondary);">—</div>
        </div>
      </div>

      <div class="zone-legend">
        <div class="zone-item">
          <div class="zone-dot btc-dominant"></div>
          <span data-zh="> 60% BTC主导" data-en="> 60% BTC Dominant">> 60% BTC主导</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot balanced"></div>
          <span data-zh="40-60% 均衡" data-en="40-60% Balanced">40-60% 均衡</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot alt-season"></div>
          <span data-zh="< 40% 山寨季" data-en="< 40% Alt Season">< 40% 山寨季</span>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title" data-zh="BTC Dominance 历史走势" data-en="BTC Dominance History">BTC Dominance 历史走势</div>
          <div class="chart-legend">
            <div class="legend-item fixed">
              <div class="legend-line dashed" style="color: #f59e0b;"></div>
              <span>60%</span>
            </div>
            <div class="legend-item fixed">
              <div class="legend-line dashed" style="color: #a855f7;"></div>
              <span>40%</span>
            </div>
            <div class="legend-item">
              <div class="legend-line" style="background: #3b82f6;"></div>
              <span>BTC.D</span>
            </div>
          </div>
        </div>
        <div class="chart-wrapper" id="chart-container"></div>
        <div class="chart-tooltip floating" id="chart-tooltip">
          <div class="tooltip-date" id="tooltip-date">—</div>
          <div class="tooltip-item">
            <div class="tooltip-dot" style="background: #3b82f6;"></div>
            <span class="tooltip-label">BTC.D:</span>
            <span class="tooltip-value" id="tooltip-value">—</span>
          </div>
        </div>
        <div class="chart-hint" data-zh="💡 拖动平移 · 滚轮缩放 · 双击重置" data-en="💡 Drag to pan · Scroll to zoom · Double-click to reset">💡 拖动平移 · 滚轮缩放 · 双击重置</div>
      </div>
      <div class="data-update-time" id="data-update-time" data-zh="数据更新: —" data-en="Data updated: —">数据更新: —</div>

      <div class="info-section">
        <h2 class="info-title" data-zh="指标说明" data-en="About BTC Dominance">指标说明</h2>
        <div class="info-text">
          <p data-zh="BTC Dominance（比特币市值占比）是比特币市值占整个加密货币市场总市值的百分比。" 
             data-en="BTC Dominance is the percentage of Bitcoin's market cap relative to the total cryptocurrency market cap.">
            BTC Dominance（比特币市值占比）是比特币市值占整个加密货币市场总市值的百分比。
          </p>
          <p data-zh="• 高占比 (>60%)：市场偏向避险，资金集中在 BTC，山寨币表现较弱" 
             data-en="• High (>60%): Risk-off sentiment, capital concentrated in BTC, altcoins underperform">
            • 高占比 (>60%)：市场偏向避险，资金集中在 BTC，山寨币表现较弱
          </p>
          <p data-zh="• 均衡区间 (40-60%)：市场相对均衡，BTC 和山寨币共同发展" 
             data-en="• Balanced (40-60%): Market equilibrium, both BTC and altcoins developing">
            • 均衡区间 (40-60%)：市场相对均衡，BTC 和山寨币共同发展
          </p>
          <p data-zh="• 低占比 (<40%)：山寨季，资金大量流入山寨币，通常出现在牛市后期" 
             data-en="• Low (<40%): Alt season, capital flowing into altcoins, typically late bull market">
            • 低占比 (<40%)：山寨季，资金大量流入山寨币，通常出现在牛市后期
          </p>
          <div class="disclaimer" 
               data-zh="⚠️ BTC Dominance 受稳定币市值影响较大。近年来稳定币市值增长迅速，导致 BTC.D 整体下移，需结合其他指标综合判断。"
               data-en="⚠️ BTC Dominance is significantly affected by stablecoin market cap. Recent stablecoin growth has pushed BTC.D lower overall. Use with other indicators.">
            ⚠️ BTC Dominance 受稳定币市值影响较大。近年来稳定币市值增长迅速，导致 BTC.D 整体下移，需结合其他指标综合判断。
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="footer-text">© 2026 Crypto3D</p>
    </div>
  </footer>

  <script>
    // === State ===
    let chart = null;
    let series = null;
    let defaultRange = null;
    let historyData = {};
    let currentData = null;

    // === BTC.D Zone Logic ===
    function getZoneInfo(value) {
      const lang = LangUtils.get();
      if (value >= 60) {
        return {
          class: 'btc-dominant',
          zone: lang === 'zh' ? 'BTC 主导' : 'BTC Dominant',
          state: '🟠 BTC 主导',
          hint: lang === 'zh' ? '资金集中在 BTC，山寨币弱势' : 'Capital in BTC, altcoins weak'
        };
      } else if (value >= 40) {
        return {
          class: 'balanced',
          zone: lang === 'zh' ? '均衡市场' : 'Balanced',
          state: '🔵 均衡',
          hint: lang === 'zh' ? '市场相对均衡' : 'Market balanced'
        };
      } else {
        return {
          class: 'alt-season',
          zone: lang === 'zh' ? '山寨季' : 'Alt Season',
          state: '🟣 山寨季',
          hint: lang === 'zh' ? '资金流向山寨币' : 'Capital flowing to alts'
        };
      }
    }

    // === Chart Controls ===
    function resetChart() {
      if (chart && defaultRange) chart.timeScale().setVisibleRange(defaultRange);
    }

    // === Display Update ===
    function updateDisplay() {
      if (!currentData) return;
      const current = currentData.current;
      const zoneInfo = getZoneInfo(current.value);

      document.getElementById('current-value').textContent = current.value.toFixed(2) + '%';
      document.getElementById('current-value').className = `stat-value ${zoneInfo.class}`;
      document.getElementById('current-zone').textContent = zoneInfo.zone;
      document.getElementById('market-state').textContent = zoneInfo.state;
      document.getElementById('zone-hint').textContent = zoneInfo.hint;
      document.getElementById('update-date').textContent = current.date;

      if (currentData.updated_at) {
        const prefix = LangUtils.get() === 'zh' ? '数据更新: ' : 'Data updated: ';
        document.getElementById('data-update-time').textContent = prefix + currentData.updated_at;
      }
    }

    // === Data Loading ===
    async function loadData() {
      try {
        const res = await fetch('../indicators/data/btc-dominance.json');
        currentData = await res.json();
        updateDisplay();
        drawChart(currentData.history);
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    // === Chart Drawing ===
    function drawChart(history) {
      chart = createChart('chart-container');

      // Prepare data
      const chartData = history.map(d => ({ time: d.date, value: d.value }));
      historyData = buildHistoryLookup(history);
      const lastDate = history[history.length - 1].date;

      // Add whitespace
      const dataWithWhitespace = addFutureWhitespace(chartData, lastDate, 90);

      // Main series
      series = chart.addLineSeries({
        color: '#3b82f6',
        lineWidth: 2,
        priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
        lastValueVisible: false,
        priceLineVisible: false,
      });
      series.setData(dataWithWhitespace);

      // Threshold lines
      createThresholdLine(series, 60, '#f59e0b');
      createThresholdLine(series, 40, '#a855f7');

      // Default range from 2014
      defaultRange = setDefaultRange(chart, '2014-01-01', lastDate);

      // Double-click reset
      document.getElementById('chart-container').addEventListener('dblclick', resetChart);

      // Tooltip
      const tooltip = document.getElementById('chart-tooltip');
      chart.subscribeCrosshairMove(param => {
        if (!param.time || !param.point || param.point.x < 0) {
          tooltip.classList.remove('visible');
          return;
        }
        
        const dateStr = typeof param.time === 'string' ? param.time :
          `${param.time.year}-${String(param.time.month).padStart(2, '0')}-${String(param.time.day).padStart(2, '0')}`;
        const data = historyData[dateStr];
        
        if (data) {
          document.getElementById('tooltip-date').textContent = formatTime(param.time);
          document.getElementById('tooltip-value').textContent = data.value.toFixed(2) + '%';
          tooltip.classList.add('visible');
        } else {
          tooltip.classList.remove('visible');
        }
      });

      // Fit content then set default range
      chart.timeScale().fitContent();
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', () => {
      LangUtils.init();
      loadData();
    });
  </script>
</body>
</html>
