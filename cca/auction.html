<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auction Details | Uniswap CCA Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <main class="container">
      <header class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1 id="auctionTitle">Auction Detail</h1>
            <p class="subtitle" id="auctionAddress"></p>
          </div>
        </div>
        <a class="button secondary" href="./index.html">‚Üê Back to Dashboard</a>
      </header>

      <div id="errorState" class="error" hidden></div>
      <div id="loading" class="loading">Loading auction data...</div>

      <section id="content" hidden>
        <!-- Áä∂ÊÄÅÂç°Áâá -->
        <div class="cards">
          <article class="card">
            <p class="card-label">Status</p>
            <p id="statusBadge" class="card-value"></p>
          </article>
          <article class="card">
            <p class="card-label">Clearing Price</p>
            <p id="clearingPrice" class="card-value">-</p>
          </article>
          <article class="card">
            <p class="card-label">Currency Raised</p>
            <p id="currencyRaised" class="card-value">-</p>
          </article>
          <article class="card">
            <p class="card-label">Total Bidders</p>
            <p id="totalBidders" class="card-value">-</p>
          </article>
        </div>

        <!-- ËøõÂ∫¶Êù° -->
        <section class="panel progress-panel">
          <h2>Auction Progress</h2>
          <div class="progress-bar large">
            <div class="progress-fill" id="progressFill"></div>
            <span class="progress-text" id="progressText">0%</span>
          </div>
          <div class="progress-info">
            <span id="startInfo">Start: -</span>
            <span id="endInfo">End: -</span>
          </div>
        </section>

        <!-- ‰∏§ÂàóÂ∏ÉÂ±Ä -->
        <div class="grid-2">
          <!-- ‰ª∑Ê†ºÂéÜÂè≤ÂõæË°® -->
          <article class="panel">
            <h2>Clearing Price History</h2>
            <div class="chart-container">
              <canvas id="priceChart"></canvas>
            </div>
            <p class="chart-note" id="chartNote"></p>
          </article>

          <!-- ÊãçÂçñ‰ø°ÊÅØ -->
          <article class="panel">
            <h2>Auction Info</h2>
            <div class="info-grid" id="infoGrid"></div>
          </article>
        </div>

        <!-- Bid ÂàóË°® -->
        <section class="panel">
          <h2>Recent Bids</h2>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Bidder</th>
                  <th>Max Price</th>
                  <th>Amount</th>
                  <th>Block</th>
                  <th>Tx</th>
                </tr>
              </thead>
              <tbody id="bidRows"></tbody>
            </table>
          </div>
          <div id="noBids" class="empty" hidden>No bids yet. Be the first!</div>
        </section>

        <!-- ‰ª£Â∏Å‰ø°ÊÅØ -->
        <section class="panel">
          <h2>Token Info</h2>
          <div class="info-grid" id="tokenInfo"></div>
        </section>
      </section>
    </main>

    <script>
      function formatCurrency(amount) {
        if (amount >= 1e6) return "$" + (amount / 1e6).toFixed(2) + "M";
        if (amount >= 1e3) return "$" + (amount / 1e3).toFixed(1) + "K";
        return "$" + Number(amount).toFixed(2);
      }

      function formatPrice(price) {
        const num = parseFloat(price);
        if (!num || num === 0) return "-";
        if (num < 0.0001) return "$" + num.toExponential(2);
        if (num < 0.01) return "$" + num.toFixed(6);
        if (num < 1) return "$" + num.toFixed(4);
        return "$" + num.toFixed(2);
      }

      function shortenAddress(addr) {
        if (!addr) return "-";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      function statusBadge(status, isGraduated) {
        const normalized = (status || "").toLowerCase();
        let badge = "";
        if (normalized === "active") badge = '<span class="status status-active">üü¢ Active</span>';
        else if (normalized === "graduated" || isGraduated) badge = '<span class="status status-settled">‚úÖ Graduated</span>';
        else if (normalized === "ended") badge = '<span class="status status-ended">üî¥ Ended</span>';
        else if (normalized === "upcoming") badge = '<span class="status status-upcoming">üïê Upcoming</span>';
        else badge = '<span class="status">' + status + '</span>';
        return badge;
      }

      async function loadAuction(id) {
        if (!id) throw new Error("Missing auction id parameter");

        try {
          const response = await fetch(`../data/cca/auctions/${id.toLowerCase()}.json`, { cache: "no-store" });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (error) {
          throw new Error("Could not load auction data. It may not exist yet.");
        }
      }

      function renderInfo(auction) {
        // Ê†áÈ¢ò
        document.getElementById("auctionTitle").textContent = auction.name || "Auction Detail";
        document.getElementById("auctionAddress").innerHTML = 
          `<a href="https://etherscan.io/address/${auction.id}" target="_blank">${auction.id}</a>`;

        // Áä∂ÊÄÅÂç°Áâá
        document.getElementById("statusBadge").innerHTML = statusBadge(auction.status, auction.metrics?.isGraduated);
        document.getElementById("clearingPrice").textContent = formatPrice(auction.metrics?.clearingPriceHuman);
        document.getElementById("currencyRaised").textContent = formatCurrency(auction.metrics?.raisedUsd || 0);
        document.getElementById("totalBidders").textContent = String(auction.metrics?.bidders || 0);

        // ËøõÂ∫¶Êù°
        const progress = auction.progress?.progressPercent || 0;
        document.getElementById("progressFill").style.width = progress + "%";
        document.getElementById("progressText").textContent = progress + "%";
        document.getElementById("startInfo").textContent = `Start Block: ${auction.config?.startBlock || "-"}`;
        document.getElementById("endInfo").textContent = `End Block: ${auction.config?.endBlock || "-"}`;

        // ÊãçÂçñ‰ø°ÊÅØÁΩëÊ†º
        const infoItems = [
          ["Floor Price", formatPrice(auction.config?.floorPriceHuman)],
          ["Claim Block", auction.config?.claimBlock || "-"],
          ["Total Supply", auction.token?.totalSupplyHuman || "-"],
          ["Bid Count", auction.metrics?.bidCount || 0],
          ["Created", auction.timestamps?.createdAt ? new Date(auction.timestamps.createdAt).toLocaleString() : "-"],
          ["Current Block", auction.progress?.currentBlock || "-"]
        ];

        const infoGrid = document.getElementById("infoGrid");
        infoGrid.innerHTML = infoItems.map(([label, value]) => 
          `<div class="info-item"><span class="label">${label}</span><strong>${value}</strong></div>`
        ).join("");

        // ‰ª£Â∏Å‰ø°ÊÅØ
        const tokenItems = [
          ["Symbol", auction.token?.symbol || "-"],
          ["Name", auction.token?.name || "-"],
          ["Address", `<a href="https://etherscan.io/token/${auction.token?.address}" target="_blank">${shortenAddress(auction.token?.address)}</a>`],
          ["Decimals", auction.token?.decimals || 18],
          ["Currency", auction.currency?.symbol || "-"],
          ["Currency Address", `<a href="https://etherscan.io/token/${auction.currency?.address}" target="_blank">${shortenAddress(auction.currency?.address)}</a>`]
        ];

        document.getElementById("tokenInfo").innerHTML = tokenItems.map(([label, value]) => 
          `<div class="info-item"><span class="label">${label}</span><strong>${value}</strong></div>`
        ).join("");
      }

      function renderChart(auction) {
        const checkpoints = auction.checkpoints || [];
        const chartNote = document.getElementById("chartNote");
        
        if (checkpoints.length === 0) {
          chartNote.textContent = "No price history available yet.";
          return;
        }

        const labels = checkpoints.map(cp => `Block ${cp.blockNumber}`);
        const values = checkpoints.map(cp => parseFloat(cp.clearingPriceHuman));

        const ctx = document.getElementById("priceChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Clearing Price (USD)",
              data: values,
              borderColor: "#36d399",
              backgroundColor: "rgba(54, 211, 153, 0.18)",
              borderWidth: 2,
              pointRadius: 4,
              tension: 0.25,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: "#e9eefc" }
              }
            },
            scales: {
              x: {
                ticks: { color: "#9aacd1" },
                grid: { color: "rgba(154, 172, 209, 0.1)" }
              },
              y: {
                ticks: {
                  color: "#9aacd1",
                  callback: (value) => "$" + value.toFixed(4)
                },
                grid: { color: "rgba(154, 172, 209, 0.1)" }
              }
            }
          }
        });

        chartNote.textContent = `${checkpoints.length} checkpoint(s) recorded`;
      }

      function renderBids(auction) {
        const bids = auction.bids || [];
        const rowsEl = document.getElementById("bidRows");
        const noBidsEl = document.getElementById("noBids");

        if (bids.length === 0) {
          noBidsEl.hidden = false;
          return;
        }

        noBidsEl.hidden = true;
        rowsEl.innerHTML = bids.map(bid => `
          <tr>
            <td><a href="https://etherscan.io/address/${bid.bidder}" target="_blank">${shortenAddress(bid.bidder)}</a></td>
            <td>${formatPrice(bid.maxPriceHuman)}</td>
            <td>${bid.amountHuman} ${auction.currency?.symbol || "USDC"}</td>
            <td>${bid.blockNumber}</td>
            <td><a href="https://etherscan.io/tx/${bid.transactionHash}" target="_blank">View</a></td>
          </tr>
        `).join("");
      }

      async function init() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        const errorEl = document.getElementById("errorState");
        const loadingEl = document.getElementById("loading");
        const contentEl = document.getElementById("content");

        try {
          const auction = await loadAuction(id);
          
          renderInfo(auction);
          renderChart(auction);
          renderBids(auction);

          loadingEl.hidden = true;
          contentEl.hidden = false;
        } catch (error) {
          loadingEl.hidden = true;
          errorEl.hidden = false;
          errorEl.textContent = error.message;
        }
      }

      init();
    </script>

    <style>
      .loading {
        text-align: center;
        padding: 3rem;
        color: #9aacd1;
      }

      .progress-panel {
        margin-bottom: 1.5rem;
      }

      .progress-bar.large {
        height: 30px;
        border-radius: 6px;
      }

      .progress-bar.large .progress-text {
        font-size: 0.9rem;
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #9aacd1;
      }

      .chart-container {
        height: 250px;
      }

      .chart-note {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #9aacd1;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .info-item .label {
        font-size: 0.85rem;
        color: #9aacd1;
      }

      .info-item strong {
        font-size: 1rem;
        color: #e9eefc;
      }

      .info-item a {
        color: #36d399;
        text-decoration: none;
      }

      .info-item a:hover {
        text-decoration: underline;
      }

      .status-ended {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
      }

      .status-upcoming {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
      }

      #auctionAddress a {
        color: #36d399;
        text-decoration: none;
        font-family: monospace;
        font-size: 0.85rem;
      }

      #auctionAddress a:hover {
        text-decoration: underline;
      }

      #bidRows a {
        color: #36d399;
        text-decoration: none;
      }

      #bidRows a:hover {
        text-decoration: underline;
      }

      .progress-bar {
        position: relative;
        width: 100%;
        background: rgba(154, 172, 209, 0.1);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #36d399 0%, #22c55e 100%);
        transition: width 0.3s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 600;
        color: #e9eefc;
      }
    </style>
  </body>
</html>
