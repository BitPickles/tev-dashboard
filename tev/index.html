<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TEV Dashboard — 加密协议估值</title>
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <style>
    /* TEV-specific overrides */
    .container { max-width: 1200px; }
    header { background: var(--bg-primary); }
    nav { display: flex; gap: 32px; }
    nav a { color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s; }
    nav a:hover, nav a.active { color: var(--text-primary); }
    .header-right { display: flex; align-items: center; gap: 24px; }
    @media (max-width: 768px) { nav { display: none; } }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo">
          <img src="../logo.svg" alt="3D" class="logo-icon">
          <span class="logo-text">Crypto3D</span>
        </a>
        <div class="header-right">
          <nav>
            <a href="../" data-i18n="nav.home">首页</a>
          </nav>
          <div class="lang-switch-tev">
            <button class="lang-btn active" data-lang="zh">中文</button>
            <button class="lang-btn" data-lang="en">EN</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="container">
        <h1 data-i18n="hero.title">加密协议估值仪表盘</h1>
        <p data-i18n="hero.subtitle">追踪协议收入真正流向代币持有者的比例。TEV Yield 是加密版的「股息率」。</p>
      </div>
    </section>

    <section class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="stat-protocols">—</div>
        <div class="stat-label" data-i18n="stats.protocols">追踪协议数</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-mcap">—</div>
        <div class="stat-label" data-i18n="stats.mcap">总市值</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-fees">—</div>
        <div class="stat-label" data-i18n="stats.fees">30日总费用</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-tev">—</div>
        <div class="stat-label" data-i18n="stats.tev">30日总 TEV</div>
      </div>
    </section>

    <section class="table-section" id="protocols">
      <div class="container">
        <div class="table-container">
          <div class="table-header">
            <div class="table-title" data-i18n="table.title">协议排名</div>
            <div class="table-filters">
              <button class="filter-btn active" data-filter="all" data-i18n="filter.all">全部</button>
              <button class="filter-btn" data-filter="lending" data-i18n="filter.lending">借贷</button>
              <button class="filter-btn" data-filter="dex" data-i18n="filter.dex">DEX</button>
              <button class="filter-btn" data-filter="cex" data-i18n="filter.cex">CEX</button>
              <button class="filter-btn" data-filter="perpetuals" data-i18n="filter.perps">Perps</button>
              <button class="filter-btn" data-filter="yield" data-i18n="filter.yield">收益</button>
            </div>
          </div>
          <div id="table-loading" class="loading">
            <div class="loading-spinner"></div>
            <div data-i18n="table.loading">加载协议数据中...</div>
          </div>
          <table id="protocol-table" style="display: none;">
            <thead>
              <tr>
                <th style="width: 50px;">#</th>
                <th data-i18n="th.protocol">协议</th>
                <th class="text-right sortable" data-sort="tvl" data-i18n="th.tvl">TVL</th>
                <th class="text-right sortable sorted desc" data-sort="tevStatus" data-i18n="th.tevStatus">TEV 状态</th>
                <th class="text-right sortable" data-sort="tevRatio" data-i18n="th.tevRatio">分配比例</th>
                <th class="text-right sortable" data-sort="mcap" data-i18n="th.mcap">市值</th>
                <th class="text-right sortable" data-sort="earningYield" data-i18n="th.earningYield">收益率</th>
                <th class="text-right sortable" data-sort="tevYield" data-i18n="th.yield">TEV Yield</th>
                <th class="text-right" data-i18n="th.confidence">可信度</th>
              </tr>
            </thead>
            <tbody id="protocol-tbody"></tbody>
          </table>
          <div class="data-update-time" id="data-update-time">数据更新: —</div>
        </div>
      </div>
    </section>

    <section class="intro-section" id="methodology">
      <div class="container">
        <div class="intro-grid">
          <div class="intro-card">
            <h2><span class="icon">📊</span> <span data-i18n="intro.what.title">什么是 TEV?</span></h2>
            <p data-i18n="intro.what.p1"><strong>TEV (Token Empowerment Value)</strong>，即「代币赋能价值」，是衡量加密协议向代币持有者分配价值能力的核心指标。</p>
            <p data-i18n="intro.what.p2">不同于传统的「协议收入」，TEV 只计算真正赋能给代币持有者的那部分——包括回购销毁、质押分红、治理激励等。</p>
            <div class="formula-box">TEV Yield = TEV ÷ Market Cap × 100%</div>
            <p data-i18n="intro.what.p3">这个比率类似传统股票的「股息率」，帮助投资者用股东回报视角评估协议价值。</p>
          </div>
          <div class="intro-card">
            <h2><span class="icon">💡</span> <span data-i18n="intro.why.title">为什么需要这个指标?</span></h2>
            <p data-i18n="intro.why.p1">加密行业发展了这么多年，大部分 Token 依然是「空气」——持有它们除了投机，几乎没有任何实际价值。这也是为什么越来越多的投资者对「持币」失去信心。</p>
            <p data-i18n="intro.why.p2">但并非所有项目都是如此。一些真正优秀的加密协议，正在通过回购、分红、销毁等方式，将协议收入回馈给代币持有者——这才是「持币者权益」应有的样子。</p>
            <p data-i18n="intro.why.p3">TEV 指标的核心目标，就是帮你筛选出那些真正在为持币者创造价值的协议，而不是只会画饼的「空气项目」。用数据说话，让赋能可量化。</p>
          </div>
        </div>
      </div>
    </section>

    <section class="author-video-section" id="about">
      <div class="container">
        <div class="author-video-grid">
          <div class="author-card">
            <div class="author-header">
              <div class="author-avatar">🔮</div>
              <div class="author-meta">
                <h3>3D</h3>
                <div class="tagline" data-i18n="author.tagline">DeFi 实战派 | TEV 框架创建者</div>
              </div>
            </div>
            <p class="author-bio" data-i18n="author.bio">专注 DeFi、链上套利及低风险机会的探索与实战。TEV（代币赋能价值）指标体系是我在实践中提炼的估值框架——用「股东回报」视角审视加密项目，区分真正回馈持币者的优质协议和只会画饼的空气项目。相信「活得久」比「赚得多」更重要，希望这个工具能帮助更多人做出理性投资决策。我在 YouTube「3D 加密频道」持续分享 DeFi 研究和实战心得，欢迎订阅交流。</p>
            <div class="author-links">
              <a href="https://x.com/22333D" target="_blank" class="author-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                <span>@22333D</span>
              </a>
              <a href="https://www.youtube.com/@Crypto36D" target="_blank" class="author-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                <span data-i18n="author.youtube">3D 加密频道</span>
              </a>
            </div>
          </div>
          <div class="video-card">
            <h2 data-i18n="video.title">📺 TEV 框架详解</h2>
            <div class="video-container">
              <iframe src="https://www.youtube.com/embed/Gl8e_t2Zo6w" title="TEV Framework Explained" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <section class="yt-banner">
    <div class="container">
      <div class="yt-banner-content">
        <div class="yt-banner-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
        </div>
        <div class="yt-banner-text">
          <h3 data-i18n="ytbanner.title">📺 订阅 3D 加密频道</h3>
          <p data-i18n="ytbanner.desc">更多 DeFi 深度分析、链上套利实战、低风险机会分享，尽在 YouTube</p>
        </div>
        <a href="https://www.youtube.com/@Crypto36D?sub_confirmation=1" target="_blank" class="yt-banner-btn" data-i18n="ytbanner.btn">立即订阅</a>
      </div>
    </div>
  </section>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-text" id="footer-updated" data-i18n="footer.loading">加载数据中...</div>
        <div class="footer-links">
          <a href="#methodology" data-i18n="footer.methodology">方法论</a>
          <a href="#" data-i18n="footer.sources">数据来源</a>
          <a href="https://github.com" target="_blank">GitHub</a>
          <a href="https://x.com/22333D" target="_blank">@22333D</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // === i18n ===
    const i18n = {
      zh: {
        'nav.home': '← 首页', 'nav.protocols': '协议数据', 'nav.methodology': '方法论', 'nav.about': '关于',
        'hero.title': '加密协议估值仪表盘', 'hero.subtitle': '追踪协议收入真正流向代币持有者的比例。TEV Yield 是加密版的「股息率」。',
        'intro.what.title': '什么是 TEV?',
        'intro.what.p1': '<strong>TEV (Token Empowerment Value)</strong>，即「代币赋能价值」，是衡量加密协议向代币持有者分配价值能力的核心指标。',
        'intro.what.p2': '不同于传统的「协议收入」，TEV 只计算真正赋能给代币持有者的那部分——包括回购销毁、质押分红、治理激励等。',
        'intro.what.p3': '这个比率类似传统股票的「股息率」，帮助投资者用股东回报视角评估协议价值。',
        'intro.why.title': '为什么需要这个指标?',
        'intro.why.p1': '加密行业发展了这么多年，大部分 Token 依然是「空气」——持有它们除了投机，几乎没有任何实际价值。这也是为什么越来越多的投资者对「持币」失去信心。',
        'intro.why.p2': '但并非所有项目都是如此。一些真正优秀的加密协议，正在通过回购、分红、销毁等方式，将协议收入回馈给代币持有者——这才是「持币者权益」应有的样子。',
        'intro.why.p3': 'TEV 指标的核心目标，就是帮你筛选出那些真正在为持币者创造价值的协议，而不是只会画饼的「空气项目」。用数据说话，让赋能可量化。',
        'video.title': '📺 TEV 框架详解', 'author.tagline': 'DeFi 实战派 | TEV 框架创建者',
        'author.bio': '专注 DeFi、链上套利及低风险机会的探索与实战。TEV（代币赋能价值）指标体系是我在实践中提炼的估值框架——用「股东回报」视角审视加密项目，区分真正回馈持币者的优质协议和只会画饼的空气项目。相信「活得久」比「赚得多」更重要，希望这个工具能帮助更多人做出理性投资决策。我在 YouTube「3D 加密频道」持续分享 DeFi 研究和实战心得，欢迎订阅交流。',
        'author.youtube': '3D 加密频道',
        'stats.protocols': '追踪协议数', 'stats.mcap': '总市值', 'stats.fees': '30日总费用', 'stats.tev': '30日总 TEV',
        'table.title': '协议排名', 'table.loading': '加载协议数据中...',
        'filter.all': '全部', 'filter.lending': '借贷', 'filter.dex': 'DEX', 'filter.cex': 'CEX', 'filter.perps': 'Perps', 'filter.yield': '收益',
        'th.protocol': '协议', 'th.earningYield': '收益率', 'th.tvl': 'TVL', 'th.tevStatus': 'TEV 状态', 'th.tevRatio': '分配比例', 'th.mcap': '市值', 'th.yield': 'TEV Yield', 'th.confidence': '可信度',
        'tevStatus.active': '活跃', 'tevStatus.partial': '部分', 'tevStatus.none': '无',
        'confidence.high': '高', 'confidence.medium': '中', 'confidence.low': '低',
        'footer.loading': '加载数据中...', 'footer.updated': '数据更新时间：{date} · 维护者 3D', 'footer.methodology': '方法论', 'footer.sources': '数据来源',
        'ytbanner.title': '📺 订阅 3D 加密频道', 'ytbanner.desc': '更多 DeFi 深度分析、链上套利实战、低风险机会分享，尽在 YouTube', 'ytbanner.btn': '立即订阅',
      },
      en: {
        'nav.home': '← Home', 'nav.protocols': 'Protocols', 'nav.methodology': 'Methodology', 'nav.about': 'About',
        'hero.title': 'Crypto Protocol Valuation Dashboard', 'hero.subtitle': 'Track how much protocol revenue actually flows to token holders. TEV Yield is the dividend yield for crypto.',
        'intro.what.title': 'What is TEV?',
        'intro.what.p1': '<strong>TEV (Token Empowerment Value)</strong> measures how much value a crypto protocol distributes to its token holders.',
        'intro.what.p2': 'Unlike "protocol revenue", TEV only counts value that actually empowers token holders — including buybacks, staking rewards, and governance incentives.',
        'intro.what.p3': 'This ratio is similar to traditional dividend yield, helping investors evaluate protocols from a shareholder return perspective.',
        'intro.why.title': 'Why This Metric?',
        'intro.why.p1': 'After years of crypto evolution, most tokens remain "vaporware" — holding them offers nothing beyond speculation. That\'s why more investors are losing faith in "holding tokens."',
        'intro.why.p2': 'But not all projects are the same. Some truly excellent DeFi protocols are giving back to token holders through buybacks, dividends, and burns — this is what "token holder equity" should look like.',
        'intro.why.p3': 'The core goal of TEV is to help you identify protocols that genuinely create value for holders, not just projects that make empty promises. Let data speak, make empowerment measurable.',
        'video.title': '📺 TEV Framework Explained', 'author.tagline': 'DeFi Practitioner | TEV Framework Creator',
        'author.bio': 'Focused on DeFi, on-chain arbitrage, and low-risk opportunities. The TEV framework is a valuation system I developed to evaluate crypto projects from a shareholder return perspective. Subscribe to my YouTube channel "3D Crypto" for DeFi research and insights.',
        'author.youtube': '3D Crypto Channel',
        'stats.protocols': 'Protocols Tracked', 'stats.mcap': 'Total Market Cap', 'stats.fees': '30d Total Fees', 'stats.tev': '30d Total TEV',
        'table.title': 'Protocol Rankings', 'table.loading': 'Loading protocol data...',
        'filter.all': 'All', 'filter.lending': 'Lending', 'filter.dex': 'DEX', 'filter.cex': 'CEX', 'filter.perps': 'Perps', 'filter.yield': 'Yield',
        'th.protocol': 'Protocol', 'th.earningYield': 'Earning Yield', 'th.tvl': 'TVL', 'th.tevStatus': 'TEV Status', 'th.tevRatio': 'Distribution', 'th.mcap': 'Market Cap', 'th.yield': 'TEV Yield', 'th.confidence': 'Confidence',
        'tevStatus.active': 'Active', 'tevStatus.partial': 'Partial', 'tevStatus.none': 'None',
        'confidence.high': 'High', 'confidence.medium': 'Medium', 'confidence.low': 'Low',
        'footer.loading': 'Loading data...', 'footer.updated': 'Data updated: {date} · Maintained by 3D', 'footer.methodology': 'Methodology', 'footer.sources': 'Data Sources',
        'ytbanner.title': '📺 Subscribe to 3D Crypto Channel', 'ytbanner.desc': 'More DeFi deep dives, on-chain arbitrage tactics, and low-risk opportunities on YouTube', 'ytbanner.btn': 'Subscribe Now',
      }
    };
    let currentLang = 'zh';
    const t = key => i18n[currentLang][key] || key;
    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
      document.querySelectorAll('[data-i18n]').forEach(el => { const k = el.dataset.i18n; if (i18n[lang][k]) el.innerHTML = i18n[lang][k]; });
      if (window.protocolData) { renderTable(window.protocolData); updateFooter(window.protocolData); }
    }

    // === Data & State ===
    let PROTOCOLS = {}, LOGO_URLS = {};
    let currentSort = { field: 'tevStatus', dir: 'desc' };
    let currentFilter = 'all';
    const TEV_STATUS_ORDER = { active: 3, partial: 2, none: 1 };

    // === Formatting ===
    const formatCurrency = (v, d = 0) => { if (v == null) return '—'; if (v >= 1e9) return '$' + (v / 1e9).toFixed(2) + 'B'; if (v >= 1e6) return '$' + (v / 1e6).toFixed(2) + 'M'; if (v >= 1e3) return '$' + (v / 1e3).toFixed(1) + 'K'; return '$' + v.toFixed(d); };
    const formatPercent = v => v == null ? '—' : (v * 100).toFixed(2) + '%';

    // === Data Loading ===
    async function loadProtocolData() {
      try {
        const baseRes = await fetch('../data/all-protocols.json');
        if (baseRes.ok) {
          const baseData = await baseRes.json();
          PROTOCOLS = baseData.protocols || {};
          if (baseData.generated_at) {
            const date = new Date(baseData.generated_at).toISOString().split('T')[0];
            document.getElementById('data-update-time').textContent = (currentLang === 'zh' ? '数据更新: ' : 'Data updated: ') + date;
          }
        }
      } catch (e) { console.warn('Failed to load all-protocols.json'); }
      const entries = Object.entries(PROTOCOLS);
      return Promise.all(entries.map(async ([key, config]) => {
        try {
          const res = await fetch(`../data/daily/${key}/latest.json`);
          if (!res.ok) throw new Error();
          return { key, ...config, ...(await res.json()) };
        } catch { return { key, ...config, error: true }; }
      }));
    }

    // === Sorting ===
    function getSortValue(p, f) {
      switch (f) {
        case 'tvl': return p.tvl || 0;
        case 'tevStatus': return TEV_STATUS_ORDER[p.tevStatus] || 0;
        case 'tevRatio': return p.tevRatio || 0;
        case 'mcap': return p.latest_record?.market_cap_usd || 0;
        case 'earningYield': { const mc = p.latest_record?.market_cap_usd || p.metrics?.current_market_cap_usd || 0; const at = (p.metrics?.trailing_30d_tev_usd || 0) * 12; return mc > 0 ? at / mc : 0; }
        case 'tevYield': return p.metrics?.tev_yield_decimal || 0;
        default: return 0;
      }
    }
    function sortProtocols(arr, f, d) {
      return [...arr].sort((a, b) => {
        // 没有 TEV yield 的项目排在后面
        const aYield = a.metrics?.tev_yield_decimal || 0;
        const bYield = b.metrics?.tev_yield_decimal || 0;
        const aHasYield = aYield > 0 ? 1 : 0;
        const bHasYield = bYield > 0 ? 1 : 0;
        if (bHasYield !== aHasYield) return bHasYield - aHasYield;
        
        // 有 yield 的协议，先按 yield 降序
        if (aHasYield && bHasYield) {
          const yieldCmp = bYield - aYield;
          if (yieldCmp !== 0) return yieldCmp;
        }
        
        let cmp = getSortValue(b, f) - getSortValue(a, f);
        if (d === 'asc') cmp = -cmp;
        if (cmp === 0) cmp = (b.tvl || 0) - (a.tvl || 0);
        return cmp;
      });
    }
    function updateSortIndicators() {
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sorted', 'asc', 'desc');
        th.textContent = t(th.dataset.i18n || th.getAttribute('data-i18n'));
      });
      const active = document.querySelector(`th[data-sort="${currentSort.field}"]`);
      if (active) active.classList.add('sorted', currentSort.dir);
    }

    // === Render ===
    function renderTable(protocols, filter = currentFilter, sortField = null, sortDir = null) {
      const tbody = document.getElementById('protocol-tbody');
      tbody.innerHTML = '';
      currentFilter = filter;
      let filtered = protocols;
      if (filter !== 'all') {
        if (filter === 'cex') filtered = protocols.filter(p => p.category === 'cex');
        else if (filter === 'perpetuals') filtered = protocols.filter(p => p.category === 'perpetuals');
        else filtered = protocols.filter(p => p.category === filter);
      }
      if (sortField) { currentSort.field = sortField; currentSort.dir = sortDir || 'desc'; }
      filtered = sortProtocols(filtered, currentSort.field, currentSort.dir);
      updateSortIndicators();

      filtered.forEach((p, i) => {
        const tevYield = p.metrics?.tev_yield_decimal || 0;
        const tevStatus = p.tevStatus || 'none';
        const tevRatio = p.tevRatio || 0;
        const mcap = p.latest_record?.market_cap_usd || p.metrics?.current_market_cap_usd || 0;
        const annualTev = (p.metrics?.trailing_30d_tev_usd || 0) * 12;
        const earningYield = mcap > 0 ? annualTev / mcap : 0;

        const row = document.createElement('tr');
        row.onclick = () => window.location.href = `protocol.html?id=${p.key}`;
        row.innerHTML = `
          <td>${i + 1}</td>
          <td><div class="protocol-cell">
            <div class="protocol-icon"><img src="${LOGO_URLS[p.key] || p.icon}" alt="${p.name}" loading="lazy" onerror="this.style.display='none';this.parentElement.textContent='${p.name.charAt(0)}'"></div>
            <div class="protocol-info"><span class="protocol-name">${p.name}</span><span class="protocol-ticker">${p.ticker}</span></div>
          </div></td>
          <td class="text-right"><span class="value">${formatCurrency(p.tvl)}</span></td>
          <td class="text-right"><span class="badge badge-${tevStatus === 'active' ? 'active' : tevStatus === 'partial' ? 'partial' : 'none'}">${tevStatus === 'active' ? '✓' : tevStatus === 'partial' ? '~' : '✗'} ${t('tevStatus.' + tevStatus)}</span></td>
          <td class="text-right"><span class="value ${tevRatio >= 0.5 ? 'value-highlight' : tevRatio > 0 ? '' : 'value-zero'}">${tevRatio > 0 ? (tevRatio * 100).toFixed(0) + '%' : '—'}</span></td>
          <td class="text-right"><span class="value">${formatCurrency(mcap)}</span></td>
          <td class="text-right"><span class="value ${earningYield > 0.1 ? 'value-highlight' : earningYield === 0 ? 'value-zero' : ''}">${earningYield > 0 ? formatPercent(earningYield) : '—'}</span></td>
          <td class="text-right"><span class="value ${tevYield > 0.05 ? 'value-highlight' : tevYield === 0 ? 'value-zero' : ''}">${formatPercent(tevYield)}</span></td>
          <td class="text-right"><span class="badge badge-${p.confidence === 'high' ? 'high' : p.confidence === 'medium' ? 'medium' : 'low'}">${p.confidence === 'high' ? '✓' : '!'} ${t('confidence.' + p.confidence)}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateStats(protocols) {
      const valid = protocols.filter(p => !p.error);
      document.getElementById('stat-protocols').textContent = valid.length;
      document.getElementById('stat-mcap').textContent = formatCurrency(valid.reduce((s, p) => s + (p.latest_record?.market_cap_usd || 0), 0));
      document.getElementById('stat-fees').textContent = formatCurrency(valid.reduce((s, p) => s + (p.trailing30dFees || 0), 0));
      document.getElementById('stat-tev').textContent = formatCurrency(valid.reduce((s, p) => s + (p.trailing30dTev || 0), 0));
    }

    function updateFooter(protocols) {
      const latest = protocols.map(p => p.updated_at).filter(Boolean).sort().reverse()[0];
      if (latest) {
        const dateStr = new Date(latest).toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : 'en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        document.getElementById('footer-updated').textContent = t('footer.updated').replace('{date}', dateStr);
      }
    }

    // === Init ===
    async function init() {
      try {
        try { const lr = await fetch('../data/logo_urls.json'); if (lr.ok) LOGO_URLS = await lr.json(); } catch {}
        const protocols = await loadProtocolData();
        window.protocolData = protocols;
        document.getElementById('table-loading').style.display = 'none';
        document.getElementById('protocol-table').style.display = 'table';
        renderTable(protocols);
        updateStats(protocols);
        updateFooter(protocols);
        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderTable(window.protocolData, btn.dataset.filter);
        }));
        document.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
          const f = th.dataset.sort, d = currentSort.field === f && currentSort.dir === 'desc' ? 'asc' : 'desc';
          renderTable(window.protocolData, currentFilter, f, d);
        }));
        document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => setLanguage(btn.dataset.lang)));
      } catch (e) {
        console.error('Init failed:', e);
        document.getElementById('table-loading').innerHTML = `<div style="color:var(--danger);">Failed to load data</div><div style="margin-top:8px;font-size:12px;">${e.message}</div>`;
      }
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
