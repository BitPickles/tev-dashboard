<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>Protocol â€” TEV Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../indicators/js/chart-utils.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo"><img src="../logo.svg" alt="3D" class="logo-icon"><span class="logo-text">Crypto3D</span></a>
        <nav class="nav-links">
          <a href="../" data-i18n="nav.home">é¦–é¡µ</a>
          <a href="./" data-i18n="nav.tev">TEV</a>
        </nav>
        <div class="lang-switch-tev">
          <button class="lang-btn active" data-lang="zh">ä¸­æ–‡</button>
          <button class="lang-btn" data-lang="en">EN</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="breadcrumb"><a href="index.html" data-i18n="nav.dashboard">Dashboard</a> / <span id="breadcrumb-name">Loading...</span></div>
    <div id="loading" class="loading"><div class="loading-spinner"></div><div data-i18n="loading">åŠ è½½ä¸­...</div></div>

    <div id="content" style="display: none;">
      <div class="protocol-header">
        <div class="protocol-title">
          <div class="protocol-icon-lg" id="protocol-icon">ğŸ”®</div>
          <div class="protocol-info">
            <h1><span id="protocol-name">Protocol</span><span class="badge badge-active" id="tev-badge">TEV Active</span></h1>
            <div class="protocol-ticker" id="protocol-ticker">TICKER Â· Category</div>
            <div class="protocol-links">
              <a href="#" class="protocol-link" id="link-website" target="_blank">ğŸŒ Website</a>
              <a href="#" class="protocol-link" id="link-docs" target="_blank">ğŸ“„ Docs</a>
              <a href="#" class="protocol-link" id="link-coingecko" target="_blank">ğŸ¦ CoinGecko</a>
            </div>
          </div>
        </div>
        <div class="tev-highlight">
          <div class="tev-status active" id="tev-status-text">TEV ACTIVE</div>
          <div class="tev-value" id="primary-value">â€”</div>
          <div class="tev-label" id="primary-label">Primary Value Accrual</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title"><span class="icon">ğŸ“Š</span><span data-i18n="section.tevSummary">TEV æ¦‚è§ˆ</span></div>
        <div class="tev-summary-grid">
          <div class="tev-summary-item"><div class="tev-summary-label" data-i18n="tev.feeSwitch">Fee Switch</div><div class="tev-summary-value" id="summary-feeswitch">â€”</div></div>
          <div class="tev-summary-item"><div class="tev-summary-label" data-i18n="tev.buybacks">Buybacks</div><div class="tev-summary-value" id="summary-buybacks">â€”</div></div>
          <div class="tev-summary-item"><div class="tev-summary-label" data-i18n="tev.dividends">Dividends</div><div class="tev-summary-value" id="summary-dividends">â€”</div></div>
          <div class="tev-summary-item"><div class="tev-summary-label" data-i18n="tev.burns">Burns</div><div class="tev-summary-value" id="summary-burns">â€”</div></div>
          <div class="tev-summary-item"><div class="tev-summary-label" data-i18n="tev.confidence">Confidence</div><div class="tev-summary-value" id="summary-confidence">â€”</div></div>
        </div>
      </div>

      <div class="section chart-section" id="tev-chart-section">
        <div class="section-title"><span class="icon">ğŸ“ˆ</span><span data-i18n="section.tevHistory">TEV å†å²è®°å½•</span></div>
        <div class="chart-container"><div class="chart-canvas-wrap"><canvas id="tev-history-chart"></canvas></div><div class="chart-stats" id="chart-stats"></div></div>
      </div>

      <div class="section" id="token-burns-section" style="display: none;">
        <div class="section-title"><span class="icon">ğŸ”¥</span><span id="burns-section-title">é”€æ¯è®°å½•</span></div>
        <div class="burn-progress-container">
          <div class="burn-progress-header"><span data-i18n="burn.progress">é”€æ¯è¿›åº¦</span><span id="burn-progress-text">â€”</span></div>
          <div class="burn-progress-bar"><div class="burn-progress-fill" id="burn-progress-fill"></div></div>
          <div class="burn-progress-stats">
            <div class="burn-stat"><span class="burn-stat-value" id="burn-total">â€”</span><span class="burn-stat-label" data-i18n="burn.totalBurned">å·²é”€æ¯</span></div>
            <div class="burn-stat"><span class="burn-stat-value" id="burn-remaining">â€”</span><span class="burn-stat-label" data-i18n="burn.remaining">å‰©ä½™ä¾›åº”</span></div>
            <div class="burn-stat"><span class="burn-stat-value" id="burn-target">100M</span><span class="burn-stat-label" data-i18n="burn.target">ç›®æ ‡ä¾›åº”</span></div>
          </div>
        </div>
        <div class="burn-charts-grid">
          <div class="burn-chart-card"><h4 id="burn-amount-title">é”€æ¯æ•°é‡</h4><div class="chart-canvas-wrap"><canvas id="burn-amount-chart"></canvas></div></div>
          <div class="burn-chart-card"><h4 id="burn-value-title">é”€æ¯ä»·å€¼ (USD)</h4><div class="chart-canvas-wrap"><canvas id="burn-value-chart"></canvas></div></div>
        </div>
      </div>

      <div class="section" id="buyback-addresses-section" style="display: none;">
        <div class="section-title"><span class="icon">ğŸ“</span><span data-i18n="section.buybackAddresses">å›è´­åœ°å€</span></div>
        <div id="buyback-stats-container"></div>
        <div id="buyback-addresses-container"></div>
      </div>
      
      <div class="section" id="buyback-chart-section" style="display: none;">
        <div class="section-title"><span class="icon">ğŸ’°</span><span data-i18n="section.buybackData">å›è´­æ•°æ®</span></div>
        <div class="buyback-overview" id="buyback-overview"></div>
        <div class="chart-container"><div class="chart-canvas-wrap"><canvas id="buyback-activity-chart"></canvas></div></div>
      </div>

      <div class="section"><div class="section-title"><span class="icon">âš™ï¸</span><span data-i18n="section.tevMechanisms">TEV æœºåˆ¶è¯¦æƒ…</span></div><div id="mechanisms-container"></div></div>
      <div class="section"><div class="section-title"><span class="icon">ğŸ”—</span><span data-i18n="section.dataSources">æ•°æ®æ¥æº</span></div><div class="sources-list" id="sources-container"></div></div>
      <div class="section" id="notes-section" style="display: none;"><div class="section-title"><span class="icon">ğŸ“</span><span data-i18n="section.notes">åˆ†æå¸ˆå¤‡æ³¨</span></div><div class="protocol-notes" id="protocol-notes"></div></div>
    </div>
  </main>

  <footer><div class="container"><div class="footer-content"><div class="footer-text">TEV Dashboard Â· <span data-i18n="footer.lastUpdated">æœ€åæ›´æ–°</span>: <span id="last-updated">â€”</span></div><div class="footer-links"><a href="https://www.youtube.com/@Crypto36D" target="_blank">YouTube</a><a href="https://x.com/22333D" target="_blank">Twitter</a></div></div></div></footer>

  <script>
    const i18n = {
      zh: { 'nav.dashboard': 'ä»ªè¡¨ç›˜', 'loading': 'åŠ è½½ä¸­...', 'section.tevSummary': 'TEV æ¦‚è§ˆ', 'section.tevHistory': 'TEV å†å²è®°å½•', 'section.buybackAddresses': 'å›è´­åœ°å€', 'section.tevMechanisms': 'TEV æœºåˆ¶è¯¦æƒ…', 'section.dataSources': 'æ•°æ®æ¥æº', 'section.notes': 'åˆ†æå¸ˆå¤‡æ³¨', 'buyback.current': 'å½“å‰é˜¶æ®µ', 'buyback.historical': 'å†å²é˜¶æ®µ', 'buyback.legacy': 'å†å²é’±åŒ…', 'buyback.disposal': 'å¤„ç½®åœ°å€', 'buyback.autoDailyBuyback': 'è‡ªåŠ¨æ¯æ—¥å›è´­', 'buyback.strategicReserve': 'æˆ˜ç•¥å›è´­å‚¨å¤‡', 'buyback.burnAddress': 'é”€æ¯åœ°å€', 'buyback.airdropLock': 'ç©ºæŠ•é”ä»“', 'section.buybackData': 'å›è´­æ•°æ®', 'chart.totalTev': 'ç´¯è®¡ TEV', 'chart.records': 'è®°å½•æ•°', 'chart.avgMonthly': 'æœˆå‡ TEV', 'chart.period': 'æ•°æ®å‘¨æœŸ', 'chart.cumulative': 'ç´¯è®¡ TEV', 'tev.feeSwitch': 'è´¹ç”¨å¼€å…³', 'tev.buybacks': 'å›è´­', 'tev.dividends': 'åˆ†çº¢', 'tev.burns': 'é”€æ¯', 'tev.confidence': 'å¯ä¿¡åº¦', 'footer.lastUpdated': 'æœ€åæ›´æ–°', 'status.active': 'æ´»è·ƒ', 'status.planned': 'è®¡åˆ’ä¸­', 'status.inactive': 'æœªæ¿€æ´»', 'status.ON': 'å·²å¼€å¯', 'status.OFF': 'æœªå¼€å¯', 'status.PARTIAL': 'éƒ¨åˆ†', 'status.NONE': 'æ— ', 'status.ACTIVE': 'æ´»è·ƒ', 'noTev.title': 'è¯¥åè®®ç›®å‰æ²¡æœ‰ TEV æœºåˆ¶', 'noTev.desc': 'ä»£å¸ä»…ç”¨äºæ²»ç†ï¼Œåè®®æ”¶å…¥æœªåˆ†é…ç»™ä»£å¸æŒæœ‰è€…', 'mechanism.type.buyback': 'å›è´­', 'mechanism.type.buyback_burn': 'å›è´­é”€æ¯', 'mechanism.type.staking_reward': 'è´¨æŠ¼å¥–åŠ±', 'mechanism.type.fee_sharing': 'è´¹ç”¨åˆ†æˆ', 'mechanism.type.ve_distribution': 've åˆ†é…', 'mechanism.type.airdrop': 'ç©ºæŠ•', 'source.governance': 'æ²»ç†', 'source.documentation': 'æ–‡æ¡£', 'source.report': 'æŠ¥å‘Š', 'source.api': 'API', 'source.onchain': 'é“¾ä¸Š', 'confidence.high': 'é«˜', 'confidence.medium': 'ä¸­', 'confidence.low': 'ä½', 'burn.progress': 'é”€æ¯è¿›åº¦', 'burn.totalBurned': 'å·²é”€æ¯', 'burn.remaining': 'å‰©ä½™ä¾›åº”', 'burn.target': 'ç›®æ ‡ä¾›åº”' },
      en: { 'nav.dashboard': 'Dashboard', 'loading': 'Loading...', 'section.tevSummary': 'TEV Summary', 'section.tevHistory': 'TEV History', 'section.buybackAddresses': 'Buyback Addresses', 'section.tevMechanisms': 'TEV Mechanisms', 'section.dataSources': 'Data Sources', 'section.notes': 'Analyst Notes', 'buyback.current': 'Current Stage', 'buyback.historical': 'Historical Stage', 'buyback.legacy': 'Legacy Wallets', 'buyback.disposal': 'Disposal Addresses', 'buyback.autoDailyBuyback': 'Auto Daily Buyback', 'buyback.strategicReserve': 'Strategic Reserve', 'buyback.burnAddress': 'Burn Address', 'buyback.airdropLock': 'Airdrop Lock', 'section.buybackData': 'Buyback Data', 'chart.totalTev': 'Total TEV', 'chart.records': 'Records', 'chart.avgMonthly': 'Avg Monthly', 'chart.period': 'Period', 'chart.cumulative': 'Cumulative TEV', 'tev.feeSwitch': 'Fee Switch', 'tev.buybacks': 'Buybacks', 'tev.dividends': 'Dividends', 'tev.burns': 'Burns', 'tev.confidence': 'Confidence', 'footer.lastUpdated': 'Last Updated', 'status.active': 'Active', 'status.planned': 'Planned', 'status.inactive': 'Inactive', 'status.ON': 'ON', 'status.OFF': 'OFF', 'status.PARTIAL': 'Partial', 'status.NONE': 'None', 'status.ACTIVE': 'Active', 'noTev.title': 'No TEV Mechanisms', 'noTev.desc': 'Token is governance-only, protocol revenue not distributed to holders', 'mechanism.type.buyback': 'Buyback', 'mechanism.type.buyback_burn': 'Buyback & Burn', 'mechanism.type.staking_reward': 'Staking Reward', 'mechanism.type.fee_sharing': 'Fee Sharing', 'mechanism.type.ve_distribution': 've Distribution', 'mechanism.type.airdrop': 'Airdrop', 'source.governance': 'Governance', 'source.documentation': 'Docs', 'source.report': 'Report', 'source.api': 'API', 'source.onchain': 'On-chain', 'confidence.high': 'High', 'confidence.medium': 'Medium', 'confidence.low': 'Low', 'burn.progress': 'Burn Progress', 'burn.totalBurned': 'Total Burned', 'burn.remaining': 'Remaining Supply', 'burn.target': 'Target Supply' }
    };
    let currentLang = 'zh';
    const t = k => i18n[currentLang][k] || k;
    const updateI18n = () => document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.dataset.i18n));
    const getProtocolId = () => new URLSearchParams(window.location.search).get('id') || 'aave';
    const fmtCurrency = v => v >= 1e9 ? '$' + (v/1e9).toFixed(2) + 'B' : v >= 1e6 ? '$' + (v/1e6).toFixed(2) + 'M' : v >= 1e3 ? '$' + (v/1e3).toFixed(1) + 'K' : '$' + v.toFixed(0);
    const getTevStatus = s => (s.fee_switch === 'ON' || s.buybacks === 'ACTIVE' || s.dividends === 'ACTIVE') ? 'active' : (s.fee_switch === 'PARTIAL' || s.dividends === 'PARTIAL') ? 'partial' : 'none';
    const getValueClass = v => { const u = (v || '').toUpperCase(); return u === 'ON' || u === 'ACTIVE' ? 'value-on' : u === 'PARTIAL' ? 'value-partial' : 'value-off'; };

    const TEV_COLORS = { buyback_burn: { bg: 'rgba(34,197,94,0.7)', border: '#22c55e' }, buyback: { bg: 'rgba(34,197,94,0.6)', border: '#22c55e' }, staking_reward: { bg: 'rgba(59,130,246,0.7)', border: '#3b82f6' }, direct_distribution: { bg: 'rgba(168,85,247,0.7)', border: '#a855f7' }, ve_reward: { bg: 'rgba(245,158,11,0.7)', border: '#f59e0b' }, fee_sharing: { bg: 'rgba(236,72,153,0.7)', border: '#ec4899' }, aggregate: { bg: 'rgba(99,102,241,0.7)', border: '#6366f1' } };
    const BURN_CONFIG = { bnb: { file: 'bnb-burns.json', ticker: 'BNB', color: 'rgba(240,185,11,0.8)', borderColor: '#f0b90b', title: { zh: 'BNB å­£åº¦é”€æ¯', en: 'BNB Quarterly Burns' }, dataType: 'quarterly', initialSupply: 2e8, targetSupply: 1e8 }, hype: { file: 'hype-burns.json', ticker: 'HYPE', color: 'rgba(59,130,246,0.8)', borderColor: '#3b82f6', title: { zh: 'HYPE æœˆåº¦é”€æ¯', en: 'HYPE Monthly Burns' }, dataType: 'monthly' }, uniswap: { file: 'uni-burns.json', ticker: 'UNI', color: 'rgba(255,0,122,0.8)', borderColor: '#ff007a', title: { zh: 'UNI æœˆåº¦é”€æ¯', en: 'UNI Monthly Burns' }, dataType: 'monthly' } };
    let tevChart = null, burnAmtChart = null, burnValChart = null, buybackChart = null;

    function renderBuybackAddresses(buybackAddresses, revenueDistribution) {
      const section = document.getElementById('buyback-addresses-section');
      const container = document.getElementById('buyback-addresses-container');
      if (!buybackAddresses) { section.style.display = 'none'; return; }
      section.style.display = 'block';
      let html = '';
      
      // Revenue distribution summary
      if (revenueDistribution) {
        html += `<div class="revenue-distribution-card">
          <div class="revenue-dist-header">${currentLang === 'zh' ? 'æ”¶å…¥åˆ†é…' : 'Revenue Distribution'}: <strong>${revenueDistribution.total_to_buyback}</strong> ${currentLang === 'zh' ? 'ç”¨äºå›è´­' : 'to buyback'}</div>
          <div class="revenue-dist-breakdown">
            ${revenueDistribution.breakdown ? Object.entries(revenueDistribution.breakdown).filter(([k]) => !k.includes('note')).map(([k, v]) => `<span class="revenue-item"><span class="revenue-label">${k.replace(/_/g, ' ')}</span><span class="revenue-value">${v}</span></span>`).join('') : ''}
          </div>
        </div>`;
      }
      
      // Current stage
      const stages = Object.entries(buybackAddresses).filter(([k]) => k.startsWith('stage_')).sort((a, b) => b[0].localeCompare(a[0]));
      stages.forEach(([stageKey, stage], idx) => {
        const isCurrent = idx === 0 || stage.status === 'current';
        const stageNum = stageKey.replace('stage_', '');
        html += `<div class="address-stage ${isCurrent ? 'current' : 'historical'}">
          <div class="stage-header">
            <span class="stage-badge ${isCurrent ? 'badge-active' : 'badge-none'}">${isCurrent ? t('buyback.current') : t('buyback.historical')}</span>
            <span class="stage-name">Stage ${stageNum}</span>
            <span class="stage-date">${stage.start_date || ''}</span>
          </div>
          <div class="address-grid">
            ${stage.auto_daily ? `<div class="address-card">
              <div class="address-label">${t('buyback.autoDailyBuyback')}</div>
              <div class="address-allocation">${stage.auto_daily.allocation || ''}</div>
              <div class="address-value"><code>${stage.auto_daily.address}</code></div>
              <a href="${stage.auto_daily.bscscan || 'https://bscscan.com/address/' + stage.auto_daily.address}" target="_blank" class="address-link">BscScan â†’</a>
            </div>` : ''}
            ${stage.strategic_reserve ? `<div class="address-card">
              <div class="address-label">${t('buyback.strategicReserve')}</div>
              <div class="address-allocation">${stage.strategic_reserve.allocation || ''}</div>
              <div class="address-value"><code>${stage.strategic_reserve.address}</code></div>
              <a href="${stage.strategic_reserve.bscscan || 'https://bscscan.com/address/' + stage.strategic_reserve.address}" target="_blank" class="address-link">BscScan â†’</a>
            </div>` : ''}
          </div>
        </div>`;
      });
      
      // Legacy wallets
      if (buybackAddresses.legacy?.addresses?.length) {
        html += `<div class="address-stage legacy">
          <div class="stage-header"><span class="stage-badge badge-none">${t('buyback.legacy')}</span><span class="stage-note">${buybackAddresses.legacy.note || ''}</span></div>
          <div class="address-grid">
            ${buybackAddresses.legacy.addresses.map(a => `<div class="address-card small">
              <div class="address-label">${a.label}</div>
              <div class="address-value"><code>${a.address}</code></div>
              <a href="${a.bscscan || 'https://bscscan.com/address/' + a.address}" target="_blank" class="address-link">BscScan â†’</a>
            </div>`).join('')}
          </div>
        </div>`;
      }
      
      // Disposal addresses
      if (buybackAddresses.disposal) {
        html += `<div class="address-stage disposal">
          <div class="stage-header"><span class="stage-badge badge-burn">ğŸ”¥ ${t('buyback.disposal')}</span></div>
          <div class="address-grid">
            ${buybackAddresses.disposal.burn_address ? `<div class="address-card burn">
              <div class="address-label">${t('buyback.burnAddress')}</div>
              <div class="address-value"><code>${buybackAddresses.disposal.burn_address}</code></div>
            </div>` : ''}
            ${buybackAddresses.disposal.airdrop_lock ? `<div class="address-card">
              <div class="address-label">${t('buyback.airdropLock')}</div>
              <div class="address-value"><code>${buybackAddresses.disposal.airdrop_lock}</code></div>
              <a href="https://bscscan.com/address/${buybackAddresses.disposal.airdrop_lock}" target="_blank" class="address-link">BscScan â†’</a>
            </div>` : ''}
          </div>
        </div>`;
      }
      
      container.innerHTML = html;
    }

    function renderMechanisms(mechanisms) {
      const c = document.getElementById('mechanisms-container');
      if (!mechanisms?.length) { c.innerHTML = `<div class="no-tev-notice"><div class="icon">âŒ</div><h3>${t('noTev.title')}</h3><p>${t('noTev.desc')}</p></div>`; return; }
      c.innerHTML = '<div class="mechanism-list">' + mechanisms.map(m => `<div class="mechanism-card"><div class="mechanism-header"><div><div class="mechanism-name">${m.name}</div><div class="mechanism-type">${t('mechanism.type.' + m.type) || m.type}</div></div><span class="mechanism-status status-${m.status}">${t('status.' + m.status) || m.status}</span></div><div class="mechanism-desc">${m.description}</div><div class="mechanism-meta">${m.start_date ? `<span>ğŸ“… ${m.start_date}</span>` : ''}${m.fee_share_percentage ? `<span>ğŸ’° ${m.fee_share_percentage}%</span>` : ''}${m.annual_budget_usd ? `<span>ğŸ’µ $${(m.annual_budget_usd / 1e6).toFixed(0)}M/year</span>` : ''}${m.source?.url ? `<a href="${m.source.url}" target="_blank">ğŸ”— ${m.source.title || 'Source'}</a>` : ''}</div></div>`).join('') + '</div>';
    }

    function renderSources(sources) {
      const c = document.getElementById('sources-container');
      if (!sources?.length) { c.innerHTML = '<div style="color:var(--text-tertiary);text-align:center;padding:20px;">No data sources</div>'; return; }
      c.innerHTML = sources.map(s => `<div class="source-item"><div><span class="source-name">${s.name}</span><span class="source-type">${t('source.' + s.type) || s.type}</span></div>${s.url ? `<a href="${s.url}" class="source-link" target="_blank">Open â†’</a>` : ''}</div>`).join('');
    }

    async function loadTevChart(pid) {
      try {
        const resp = await fetch(`../data/protocols/${pid}/tev-records.json`);
        if (!resp.ok) return;
        const { records } = await resp.json();
        if (!records?.length) return;
        records.sort((a, b) => new Date(a.date) - new Date(b.date));
        const types = [...new Set(records.map(r => r.type))];
        const labels = records.map(r => r.period || new Date(r.date).toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : 'en-US', { year: 'numeric', month: 'short' }));
        const barDs = types.map(type => { const c = TEV_COLORS[type] || { bg: 'rgba(161,161,170,0.5)', border: '#a1a1aa' }; return { label: t('mechanism.type.' + type) || type, data: records.map(r => r.type === type ? r.amount_usd : 0), backgroundColor: c.bg, borderColor: c.border, borderWidth: 1, borderRadius: 4, type: 'bar', yAxisID: 'y', order: 2 }; });
        let cum = 0; const cumData = records.map(r => { cum += r.amount_usd; return cum; });
        const lineDs = { label: t('chart.cumulative'), data: cumData, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', borderWidth: 2, pointRadius: 3, fill: true, type: 'line', yAxisID: 'y2', tension: 0.3, order: 1 };
        const ctx = document.getElementById('tev-history-chart').getContext('2d');
        if (tevChart) tevChart.destroy();
        tevChart = new Chart(ctx, { data: { labels, datasets: [...barDs, lineDs] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top', labels: { color: '#a1a1aa', font: { size: 11 }, boxWidth: 12, padding: 16 } }, tooltip: { backgroundColor: '#18181b', titleColor: '#fafafa', bodyColor: '#a1a1aa', borderColor: '#27272a', borderWidth: 1, callbacks: { label: ctx => ctx.raw === 0 ? null : ` ${ctx.dataset.label}: ${fmtCurrency(ctx.raw)}` }, filter: i => i.raw !== 0 } }, scales: { x: { grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a', font: { size: 11 } } }, y: { position: 'left', grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a', callback: v => fmtCurrency(v) }, title: { display: true, text: currentLang === 'zh' ? 'å•æœŸ TEV' : 'Period TEV', color: '#71717a' } }, y2: { position: 'right', grid: { display: false }, ticks: { color: '#f59e0b', callback: v => fmtCurrency(v) }, title: { display: true, text: t('chart.cumulative'), color: '#f59e0b' } } } } });
        const total = records.reduce((s, r) => s + r.amount_usd, 0);
        document.getElementById('chart-stats').innerHTML = `<div class="chart-stat"><div class="chart-stat-value">${fmtCurrency(total)}</div><div class="chart-stat-label">${t('chart.totalTev')}</div></div><div class="chart-stat"><div class="chart-stat-value">${records.length}</div><div class="chart-stat-label">${t('chart.records')}</div></div><div class="chart-stat"><div class="chart-stat-value">${fmtCurrency(total / records.length)}</div><div class="chart-stat-label">${t('chart.avgMonthly')}</div></div><div class="chart-stat"><div class="chart-stat-value">${records[0].period || records[0].date} â†’ ${records[records.length - 1].period || records[records.length - 1].date}</div><div class="chart-stat-label">${t('chart.period')}</div></div>`;
        document.getElementById('tev-chart-section').classList.add('has-data');
      } catch (e) { console.log('No TEV records:', e.message); }
    }

    async function loadBurnsChart(pid) {
      const cfg = BURN_CONFIG[pid];
      if (!cfg) return;
      try {
        const resp = await fetch(`../data/${cfg.file}`);
        if (!resp.ok) return;
        const data = await resp.json();
        document.getElementById('token-burns-section').style.display = 'block';
        document.getElementById('burns-section-title').textContent = cfg.title[currentLang];
        const pLbl = cfg.dataType === 'quarterly' ? (currentLang === 'zh' ? 'å­£åº¦' : 'Quarterly') : (currentLang === 'zh' ? 'æœˆåº¦' : 'Monthly');
        document.getElementById('burn-amount-title').textContent = `${pLbl}é”€æ¯ (${cfg.ticker})`;
        document.getElementById('burn-value-title').textContent = `${pLbl}ä»·å€¼ (USD)`;
        const totalBurned = data.total_burned, totalSupply = data.total_supply || cfg.initialSupply || 1e9, targetSupply = cfg.targetSupply || data.target_supply;
        let progress, progressText;
        if (targetSupply) { const burnTarget = (cfg.initialSupply || totalSupply) - targetSupply; progress = (totalBurned / burnTarget) * 100; progressText = `${(totalBurned / 1e6).toFixed(2)}M / ${(burnTarget / 1e6).toFixed(0)}M`; } else { progress = (totalBurned / totalSupply) * 100; progressText = `${(totalBurned / 1e6).toFixed(2)}M (${progress.toFixed(2)}%)`; }
        document.getElementById('burn-progress-fill').style.width = `${Math.min(progress, 100)}%`;
        document.getElementById('burn-progress-fill').style.background = `linear-gradient(90deg, ${cfg.borderColor}, ${cfg.color})`;
        document.getElementById('burn-progress-fill').textContent = `${progress.toFixed(1)}%`;
        document.getElementById('burn-progress-text').textContent = progressText;
        document.getElementById('burn-total').textContent = `${(totalBurned / 1e6).toFixed(2)}M`;
        document.getElementById('burn-remaining').textContent = `${((data.current_supply || totalSupply - totalBurned) / 1e6).toFixed(2)}M`;
        document.getElementById('burn-target').textContent = `${((targetSupply || totalSupply) / 1e6).toFixed(0)}M`;
        const burns = cfg.dataType === 'quarterly' ? (data.quarterly_burns || []).filter(b => !b.note?.includes('ä¼°ç®—')) : data.monthly_burns || [];
        if (!burns.length) { document.querySelector('.burn-charts-grid').style.display = 'none'; return; }
        const labels = burns.map(b => b.quarter || b.month), amounts = burns.map(b => b.amount), values = burns.map(b => b.value_usd);
        if (burnAmtChart) burnAmtChart.destroy();
        burnAmtChart = new Chart(document.getElementById('burn-amount-chart').getContext('2d'), { type: 'bar', data: { labels, datasets: [{ data: amounts, backgroundColor: cfg.color, borderColor: cfg.borderColor, borderWidth: 1, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.raw.toLocaleString()} ${cfg.ticker}` } } }, scales: { x: { grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a', maxRotation: 45 } }, y: { grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a', callback: v => (v / 1e6).toFixed(1) + 'M' } } } } });
        if (burnValChart) burnValChart.destroy();
        burnValChart = new Chart(document.getElementById('burn-value-chart').getContext('2d'), { type: 'line', data: { labels, datasets: [{ data: values, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3, pointRadius: 3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` $${(ctx.raw / 1e6).toFixed(1)}M` } } }, scales: { x: { grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a', maxRotation: 45 } }, y: { grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a', callback: v => '$' + (v / 1e6).toFixed(0) + 'M' } } } } });
      } catch (e) { console.log(`No burns data for ${pid}:`, e.message); }
    }

    async function loadBuybackData(pid) {
      try {
        const resp = await fetch(`../data/${pid}-buybacks.json`);
        if (!resp.ok) return;
        const data = await resp.json();
        
        document.getElementById('buyback-chart-section').style.display = 'block';
        
        const s = data.summary || {};
        const w = data.wallets?.stage_6_auto || {};
        const dailyData = data.daily_buybacks || [];
        
        // Render overview
        const overview = document.getElementById('buyback-overview');
        overview.innerHTML = `
          <div class="buyback-stats-grid">
            <div class="buyback-stat-card main">
              <div class="stat-label">${currentLang === 'zh' ? 'ç´¯è®¡å›è´­' : 'Total Buyback'}</div>
              <div class="stat-value">${fmtCurrency(s.stage_6_total_usd || 0)}</div>
              <div class="stat-sub">${(s.stage_6_total_aster/1e6).toFixed(2)}M ASTER</div>
            </div>
            <div class="buyback-stat-card">
              <div class="stat-label">${currentLang === 'zh' ? 'æ—¥å‡å›è´­' : 'Avg Daily'}</div>
              <div class="stat-value">${fmtCurrency(s.avg_daily_usd || 0)}</div>
              <div class="stat-sub">~${((s.avg_daily_aster||0)/1e6).toFixed(2)}M ASTER</div>
            </div>
            <div class="buyback-stat-card">
              <div class="stat-label">${currentLang === 'zh' ? 'è¿è¡Œå¤©æ•°' : 'Days'}</div>
              <div class="stat-value">${s.stage_6_days || 0}</div>
            </div>
            <div class="buyback-stat-card">
              <div class="stat-label">${currentLang === 'zh' ? 'å›è´­é’±åŒ…' : 'Wallet'}</div>
              <div class="stat-value" style="font-size:12px;"><a href="${w.bscscan}" target="_blank" style="color:var(--blue);">${w.address?.slice(0,8)}...</a></div>
            </div>
          </div>
          ${s.data_note ? `<div class="buyback-note">âš ï¸ ${s.data_note}</div>` : ''}
        `;
        
        // Render daily chart
        if (dailyData.length) {
          const ctx = document.getElementById('buyback-activity-chart').getContext('2d');
          if (buybackChart) buybackChart.destroy();
          
          const labels = dailyData.map(d => d.date.slice(5));
          const usdData = dailyData.map(d => d.usd);
          const asterData = dailyData.map(d => d.aster);
          
          buybackChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: currentLang === 'zh' ? 'æ¯æ—¥å›è´­ (USD)' : 'Daily Buyback (USD)',
                data: usdData,
                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                borderColor: '#22c55e',
                borderWidth: 1,
                borderRadius: 4,
                yAxisID: 'y'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx) => {
                      const i = ctx.dataIndex;
                      return [
                        ` ${fmtCurrency(usdData[i])}`,
                        ` ${(asterData[i]/1e6).toFixed(2)}M ASTER`
                      ];
                    }
                  }
                }
              },
              scales: {
                x: { grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a' } },
                y: { grid: { color: 'rgba(39,39,42,0.5)' }, ticks: { color: '#71717a', callback: v => '$' + (v/1e3).toFixed(0) + 'K' }, beginAtZero: true }
              }
            }
          });
        }
      } catch (e) { console.log(`No buyback data for ${pid}:`, e.message); }
    }

    async function init() {
      const pid = getProtocolId();
      try {
        let logoUrls = {}; try { const lr = await fetch('../data/logo_urls.json'); if (lr.ok) logoUrls = await lr.json(); } catch {}
        const resp = await fetch(`../data/protocols/${pid}/config.json`);
        if (!resp.ok) throw new Error('Protocol not found');
        const cfg = await resp.json();
        document.title = `${cfg.name} â€” TEV Dashboard`;
        document.getElementById('breadcrumb-name').textContent = cfg.name;
        const iconEl = document.getElementById('protocol-icon');
        const logoUrl = logoUrls[pid] || (cfg.icon?.startsWith('http') ? cfg.icon : null);
        if (logoUrl) iconEl.innerHTML = `<img src="${logoUrl}" alt="${cfg.ticker}" loading="lazy" onerror="this.style.display='none';this.parentElement.textContent='${cfg.name.charAt(0)}'">`;
        else iconEl.textContent = cfg.name.charAt(0);
        document.getElementById('protocol-name').textContent = cfg.name;
        const catMap = { lending: 'å€Ÿè´·', dex: 'DEX', liquid_staking: 'æµåŠ¨æ€§è´¨æŠ¼', restaking: 'å†è´¨æŠ¼', perpetuals: 'æ°¸ç»­åˆçº¦', yield: 'æ”¶ç›Š' };
        document.getElementById('protocol-ticker').textContent = `${cfg.ticker} Â· ${currentLang === 'zh' ? (catMap[cfg.category] || cfg.category) : cfg.category}`;
        const tevStatus = getTevStatus(cfg.tev_summary || {});
        const badge = document.getElementById('tev-badge');
        badge.className = `badge badge-${tevStatus === 'active' ? 'active' : tevStatus === 'partial' ? 'partial' : 'none'}`;
        badge.textContent = tevStatus === 'active' ? 'TEV Active' : tevStatus === 'partial' ? 'TEV Partial' : 'No TEV';
        document.getElementById('link-website').href = cfg.website || '#';
        document.getElementById('link-docs').href = cfg.docs || '#';
        document.getElementById('link-coingecko').href = cfg.token?.coingecko_id ? `https://www.coingecko.com/en/coins/${cfg.token.coingecko_id}` : '#';
        const statusText = document.getElementById('tev-status-text');
        statusText.textContent = tevStatus === 'active' ? 'TEV ACTIVE' : tevStatus === 'partial' ? 'TEV PARTIAL' : 'NO TEV';
        statusText.className = `tev-status ${tevStatus}`;
        document.getElementById('primary-value').textContent = cfg.tev_summary?.fee_switch === 'ON' ? 'âœ“ ON' : cfg.tev_summary?.fee_switch === 'PARTIAL' ? '~ PARTIAL' : 'âœ— OFF';
        document.getElementById('primary-label').textContent = cfg.tev_summary?.primary_value_accrual || 'â€”';
        const s = cfg.tev_summary || {};
        ['feeswitch', 'buybacks', 'dividends', 'burns'].forEach(k => { const el = document.getElementById(`summary-${k}`); const v = s[k.replace('feeswitch', 'fee_switch')] || 'NONE'; el.textContent = t('status.' + v); el.className = `tev-summary-value ${getValueClass(v)}`; });
        const confEl = document.getElementById('summary-confidence');
        confEl.textContent = t('confidence.' + (cfg.confidence || 'medium'));
        confEl.className = `tev-summary-value ${cfg.confidence === 'high' ? 'value-on' : cfg.confidence === 'low' ? 'value-off' : 'value-partial'}`;
        renderBuybackAddresses(cfg.buyback_addresses, cfg.revenue_distribution);
        renderMechanisms(cfg.tev_mechanisms);
        renderSources(cfg.data_sources);
        if (cfg.notes) { document.getElementById('notes-section').style.display = 'block'; document.getElementById('protocol-notes').textContent = cfg.notes; }
        document.getElementById('last-updated').textContent = cfg.last_updated || 'â€”';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        loadTevChart(pid);
        if (['bnb', 'hype', 'uniswap'].includes(pid)) loadBurnsChart(pid);
        if (['aster'].includes(pid)) loadBuybackData(pid);
      } catch (e) {
        console.error('Failed:', e);
        document.getElementById('loading').innerHTML = `<div style="color:var(--danger);">Failed to load protocol</div><div style="margin-top:8px;font-size:12px;">${e.message}</div><div style="margin-top:16px;"><a href="index.html" style="color:var(--blue);">â† Back</a></div>`;
      }
    }

    document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => {
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentLang = btn.dataset.lang;
      updateI18n();
      init();
    }));
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
