<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>BMRI æŒ‡æ ‡ â€” Crypto3D</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <script src="../indicators/js/chart-utils.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo">
          <img src="../logo.svg" alt="3D" class="logo-icon">
          <span class="logo-text">Crypto3D</span>
        </a>
        <div class="nav-links">
          <a href="../" data-zh="é¦–é¡µ" data-en="Home">é¦–é¡µ</a>
          <a href="../tev/" data-zh="TEV" data-en="TEV">TEV</a>
          <a href="../ahr999/">AHR999</a>
          <div class="lang-switch" onclick="LangUtils.toggle(); updateDisplay();">
            <span id="lang-zh" class="active">ä¸­æ–‡</span>
            <span>/</span>
            <span id="lang-en">EN</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div data-zh="åŠ è½½ BMRI æ•°æ®ä¸­..." data-en="Loading BMRI data...">åŠ è½½ BMRI æ•°æ®ä¸­...</div>
      </div>

      <!-- Main Content (hidden until data loads) -->
      <div id="content" style="display: none;">
      <div class="page-header">
        <h1 class="page-title">BMRI <span data-zh="å®è§‚é£é™©æŒ‡æ ‡" data-en="Macro Risk Index">å®è§‚é£é™©æŒ‡æ ‡</span></h1>
        <p class="page-subtitle" data-zh="Bitcoin Macro Risk Index â€” ç»¼åˆåˆ©ç‡ã€æµåŠ¨æ€§ã€é£é™©åå¥½çš„å®è§‚ç¯å¢ƒè¯„ä¼°" data-en="Bitcoin Macro Risk Index â€” Rates, Liquidity, and Risk Appetite assessment">Bitcoin Macro Risk Index â€” ç»¼åˆåˆ©ç‡ã€æµåŠ¨æ€§ã€é£é™©åå¥½çš„å®è§‚ç¯å¢ƒè¯„ä¼°</p>
      </div>

      <!-- Version Tabs -->
      <div class="version-tabs">
        <div class="version-tab active" data-version="6m" onclick="switchVersion('6m')">
          <div>6M <span data-zh="ç‰ˆ" data-en="Version">ç‰ˆ</span></div>
          <div class="version-desc" data-zh="ä¸­å‘¨æœŸè¶‹åŠ¿ï¼Œ1-6æœˆè°ƒä»“" data-en="Medium-term, 1-6 month rebalancing">ä¸­å‘¨æœŸè¶‹åŠ¿ï¼Œ1-6æœˆè°ƒä»“</div>
        </div>
        <div class="version-tab" data-version="1m" onclick="switchVersion('1m')">
          <div>1M <span data-zh="ç‰ˆ" data-en="Version">ç‰ˆ</span></div>
          <div class="version-desc" data-zh="çŸ­æœŸå†²å‡»ï¼Œ1-4å‘¨è°ƒä»“" data-en="Short-term, 1-4 week rebalancing">çŸ­æœŸå†²å‡»ï¼Œ1-4å‘¨è°ƒä»“</div>
        </div>
      </div>

      <!-- Main BMRI Value -->
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
        <div class="stat-card" style="flex: 0 0 auto; padding: 12px 24px;">
          <div class="stat-label">BMRI</div>
          <div class="stat-value" id="bmri-value">â€”</div>
          <div class="stat-hint" id="market-state">â€”</div>
        </div>
        <div class="zone-legend" style="margin: 0;">
          <div class="zone-item"><div class="zone-dot risk-on"></div><span id="threshold-on">â€”</span></div>
          <div class="zone-item"><div class="zone-dot neutral"></div><span data-zh="ä¸­æ€§" data-en="Neutral">ä¸­æ€§</span></div>
          <div class="zone-item"><div class="zone-dot risk-off"></div><span id="threshold-off">â€”</span></div>
        </div>
      </div>
      <!-- Hidden elements for JS compatibility -->
      <span id="bmri-regime" style="display:none;"></span>
      <span id="regime-hint" style="display:none;"></span>

      <!-- Zone Legend (hidden, replaced above) -->
      <div class="zone-legend" style="display: none;">
      <div class="zone-legend">
        <div class="zone-item">
          <div class="zone-dot risk-on"></div>
          <span id="threshold-on">â€”</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot neutral"></div>
          <span data-zh="ä¸­æ€§åŒºé—´" data-en="Neutral Zone">ä¸­æ€§åŒºé—´</span>
        </div>
        <div class="zone-item">
          <div class="zone-dot risk-off"></div>
          <span id="threshold-off">â€”</span>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title" data-zh="BMRI å†å²èµ°åŠ¿" data-en="BMRI History">BMRI å†å²èµ°åŠ¿</div>
          <div class="chart-legend">
            <div class="legend-item fixed"><div class="legend-line dashed" style="color: #22c55e;"></div><span id="legend-on">30</span></div>
            <div class="legend-item fixed"><div class="legend-line dashed" style="color: #ef4444;"></div><span id="legend-off">70</span></div>
            <div class="legend-item" data-series="bmri" onclick="toggleSeries('bmri')"><div class="legend-line" style="background: #3b82f6;"></div><span>BMRI</span></div>
            <div class="legend-item disabled" data-series="rates" onclick="toggleSeries('rates')"><div class="legend-line" style="background: #06b6d4;"></div><span>Rates</span></div>
            <div class="legend-item disabled" data-series="liq" onclick="toggleSeries('liq')"><div class="legend-line" style="background: #22c55e;"></div><span>Liquidity</span></div>
            <div class="legend-item disabled" data-series="risk" onclick="toggleSeries('risk')"><div class="legend-line" style="background: #f59e0b;"></div><span>Risk</span></div>
            <div class="legend-item disabled" data-series="btcMcap" onclick="toggleSeries('btcMcap')"><div class="legend-line" style="background: #f7931a;"></div><span data-zh="BTCå¸‚å€¼" data-en="BTC MCap">BTCå¸‚å€¼</span></div>
            <div class="legend-item disabled" data-series="totalMcap" onclick="toggleSeries('totalMcap')"><div class="legend-line" style="background: #8b5cf6;"></div><span data-zh="æ€»å¸‚å€¼" data-en="Total MCap">æ€»å¸‚å€¼</span></div>
          </div>
        </div>
        <div class="chart-wrapper" id="chart-container"></div>
        <div class="chart-tooltip floating" id="chart-tooltip">
          <div class="tooltip-date" id="tooltip-date">â€”</div>
          <div class="tooltip-item" id="tooltip-bmri"><div class="tooltip-dot" style="background: #3b82f6;"></div><span class="tooltip-label">BMRI:</span><span class="tooltip-value" id="tooltip-bmri-value">â€”</span></div>
          <div class="tooltip-item" id="tooltip-rates" style="display:none;"><div class="tooltip-dot" style="background: #06b6d4;"></div><span class="tooltip-label">Rates:</span><span class="tooltip-value" id="tooltip-rates-value">â€”</span></div>
          <div class="tooltip-item" id="tooltip-liq" style="display:none;"><div class="tooltip-dot" style="background: #22c55e;"></div><span class="tooltip-label">Liq:</span><span class="tooltip-value" id="tooltip-liq-value">â€”</span></div>
          <div class="tooltip-item" id="tooltip-risk" style="display:none;"><div class="tooltip-dot" style="background: #f59e0b;"></div><span class="tooltip-label">Risk:</span><span class="tooltip-value" id="tooltip-risk-value">â€”</span></div>
          <div class="tooltip-item" id="tooltip-btcMcap" style="display:none;"><div class="tooltip-dot" style="background: #f7931a;"></div><span class="tooltip-label">BTC:</span><span class="tooltip-value" id="tooltip-btcMcap-value">â€”</span></div>
          <div class="tooltip-item" id="tooltip-totalMcap" style="display:none;"><div class="tooltip-dot" style="background: #8b5cf6;"></div><span class="tooltip-label">Total:</span><span class="tooltip-value" id="tooltip-totalMcap-value">â€”</span></div>
        </div>
        <div class="chart-hint" data-zh="ğŸ’¡ æ‹–åŠ¨å¹³ç§» Â· æ»šè½®ç¼©æ”¾ Â· åŒå‡»é‡ç½®" data-en="ğŸ’¡ Drag to pan Â· Scroll to zoom Â· Double-click to reset">ğŸ’¡ æ‹–åŠ¨å¹³ç§» Â· æ»šè½®ç¼©æ”¾ Â· åŒå‡»é‡ç½®</div>
        <div class="data-update-time" id="data-update-time">â€”</div>
      </div>

      <!-- Detail Stats (below chart) -->
      <div style="display: flex; gap: 12px; margin-bottom: 24px;">
        <div class="stat-card" style="flex: 1; min-width: 0;">
          <div class="stat-label">Rates <span style="color: var(--text-tertiary);">(åˆ©ç‡)</span></div>
          <div class="stat-value" style="font-size: 20px;" id="rates-value">â€”</div>
          <div class="bucket-bar"><div class="bucket-fill" id="rates-bar"></div></div>
        </div>
        <div class="stat-card" style="flex: 1; min-width: 0;">
          <div class="stat-label">Liquidity <span style="color: var(--text-tertiary);">(æµåŠ¨æ€§)</span></div>
          <div class="stat-value" style="font-size: 20px;" id="liq-value">â€”</div>
          <div class="bucket-bar"><div class="bucket-fill" id="liq-bar"></div></div>
        </div>
        <div class="stat-card" style="flex: 1; min-width: 0;">
          <div class="stat-label">Risk <span style="color: var(--text-tertiary);">(é£é™©åå¥½)</span></div>
          <div class="stat-value" style="font-size: 20px;" id="risk-value">â€”</div>
          <div class="bucket-bar"><div class="bucket-fill" id="risk-bar"></div></div>
        </div>
        <div class="stat-card" style="flex: 0.6; min-width: 0;">
          <div class="stat-label" data-zh="æ•°æ®æ›´æ–°" data-en="Updated">æ•°æ®æ›´æ–°</div>
          <div class="stat-value" style="font-size: 14px;" id="update-date">â€”</div>
        </div>
      </div>

      <!-- Info Sections -->
      <div class="info-section">
        <h2 class="info-title" data-zh="ğŸ’¡ ä»€ä¹ˆæ˜¯ BMRIï¼Ÿ" data-en="ğŸ’¡ What is BMRI?">ğŸ’¡ ä»€ä¹ˆæ˜¯ BMRIï¼Ÿ</h2>
        <div class="info-text">
          <p data-zh="BMRIï¼ˆBitcoin Macro Risk Indexï¼‰æ˜¯ä¸€ä¸ªå®è§‚é£é™©è¯„ä¼°æŒ‡æ ‡ï¼Œå¸®åŠ©ä½ åˆ¤æ–­ã€Œç°åœ¨çš„å®è§‚ç¯å¢ƒå¯¹æ¯”ç‰¹å¸æ˜¯å‹å¥½è¿˜æ˜¯ä¸å‹å¥½ã€ã€‚" data-en="BMRI (Bitcoin Macro Risk Index) is a macro risk indicator that helps you determine whether the current macro environment is favorable or unfavorable for Bitcoin.">BMRIï¼ˆBitcoin Macro Risk Indexï¼‰æ˜¯ä¸€ä¸ªå®è§‚é£é™©è¯„ä¼°æŒ‡æ ‡ï¼Œå¸®åŠ©ä½ åˆ¤æ–­ã€Œç°åœ¨çš„å®è§‚ç¯å¢ƒå¯¹æ¯”ç‰¹å¸æ˜¯å‹å¥½è¿˜æ˜¯ä¸å‹å¥½ã€ã€‚</p>
          <p><strong>æ ¸å¿ƒé€»è¾‘ï¼š</strong>æ¯”ç‰¹å¸è™½ç„¶å¸¸è¢«ç§°ä¸ºã€Œæ•°å­—é»„é‡‘ã€ï¼Œä½†å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé£é™©èµ„äº§ã€‚å½“å…¨çƒæµåŠ¨æ€§å……è£•ã€åˆ©ç‡ä¸‹é™ã€å¸‚åœºé£é™©åå¥½ä¸Šå‡æ—¶ï¼Œæ¯”ç‰¹å¸å¾€å¾€è¡¨ç°æ›´å¥½ï¼›åä¹‹åˆ™æ‰¿å‹ã€‚</p>
          <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 12px 0;">
            <p style="margin: 0 0 8px 0;">ğŸŸ¢ <strong>Risk-On</strong>ï¼šå®è§‚ç¯å¢ƒå‹å¥½ï¼Œé€‚åˆæŒæœ‰æˆ–åŠ ä»“</p>
            <p style="margin: 0 0 8px 0;">ğŸŸ¡ <strong>Neutral</strong>ï¼šå®è§‚ç¯å¢ƒä¸­æ€§ï¼Œç»´æŒç°æœ‰é…ç½®</p>
            <p style="margin: 0;">ğŸ”´ <strong>Risk-Off</strong>ï¼šå®è§‚ç¯å¢ƒæ¶åŒ–ï¼Œè€ƒè™‘å‡ä»“æˆ–å¯¹å†²</p>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title" data-zh="ğŸ“Š ä¸‰å¤§ç»„æˆéƒ¨åˆ†" data-en="ğŸ“Š Three Components">ğŸ“Š ä¸‰å¤§ç»„æˆéƒ¨åˆ†</h2>
        <div class="info-text">
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0; border-left: 4px solid var(--blue);">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--blue);">ğŸ“‰ Rates åˆ©ç‡æ¡¶ï¼ˆæƒé‡ 35%ï¼‰</h3>
            <p style="margin-bottom: 8px;"><strong>ç›‘æµ‹ä»€ä¹ˆï¼š</strong>ç¾å›½å›½å€ºåˆ©ç‡çš„å˜åŒ–æ–¹å‘</p>
            <p style="color: var(--text-tertiary); font-size: 13px;">æ•°æ®æ¥æºï¼š10å¹´æœŸç¾å€ºåä¹‰åˆ©ç‡ (DGS10)ã€10å¹´æœŸ TIPS å®é™…åˆ©ç‡ (DFII10)</p>
          </div>
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0; border-left: 4px solid var(--accent);">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--accent);">ğŸ’§ Liquidity æµåŠ¨æ€§æ¡¶ï¼ˆæƒé‡ 35%ï¼‰</h3>
            <p style="margin-bottom: 8px;"><strong>ç›‘æµ‹ä»€ä¹ˆï¼š</strong>å…¨çƒç¾å…ƒæµåŠ¨æ€§çš„æ¾ç´§ç¨‹åº¦</p>
            <p style="color: var(--text-tertiary); font-size: 13px;">æ•°æ®æ¥æºï¼šç¾å…ƒæŒ‡æ•° (DXY)ã€ç¾è”å‚¨èµ„äº§è´Ÿå€ºè¡¨ (WALCL)ã€éš”å¤œé€†å›è´­ (RRP)</p>
          </div>
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0; border-left: 4px solid var(--warning);">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--warning);">âš¡ Risk é£é™©åå¥½æ¡¶ï¼ˆæƒé‡ 30%ï¼‰</h3>
            <p style="margin-bottom: 8px;"><strong>ç›‘æµ‹ä»€ä¹ˆï¼š</strong>å¸‚åœºçš„ææ…Œç¨‹åº¦å’Œä¿¡ç”¨é£é™©</p>
            <p style="color: var(--text-tertiary); font-size: 13px;">æ•°æ®æ¥æºï¼šVIX ææ…ŒæŒ‡æ•° (VIXCLS)ã€é«˜æ”¶ç›Šå€ºä¿¡ç”¨åˆ©å·® (HY OAS)</p>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title" data-zh="ğŸ”„ 1M ç‰ˆ vs 6M ç‰ˆ" data-en="ğŸ”„ 1M vs 6M Version">ğŸ”„ 1M ç‰ˆ vs 6M ç‰ˆ</h2>
        <div class="info-text">
          <table class="info-table">
            <thead><tr><th></th><th>6M ç‰ˆï¼ˆæ¨èï¼‰</th><th>1M ç‰ˆ</th></tr></thead>
            <tbody>
              <tr><td style="font-weight: 500;">é€‚ç”¨å‘¨æœŸ</td><td>1-6 ä¸ªæœˆè°ƒä»“</td><td>1-4 å‘¨è°ƒä»“</td></tr>
              <tr><td style="font-weight: 500;">ä¿¡å·ç‰¹ç‚¹</td><td>æ›´ç¨³å®šï¼Œè¿‡æ»¤å™ªéŸ³</td><td>æ›´æ•æ„Ÿï¼Œå¿«é€Ÿå“åº”</td></tr>
              <tr><td style="font-weight: 500;">é˜ˆå€¼</td><td>Â±0.6</td><td>Â±0.5</td></tr>
            </tbody>
          </table>
          <div class="disclaimer">ğŸ’¡ <strong>å»ºè®®ï¼š</strong>å¤§å¤šæ•°æŠ•èµ„è€…ä½¿ç”¨ 6M ç‰ˆä½œä¸ºä¸»è¦å‚è€ƒã€‚å¦‚æœä½ éœ€è¦æ›´åŠæ—¶çš„çŸ­æœŸé¢„è­¦ï¼Œå¯ä»¥å åŠ å‚è€ƒ 1M ç‰ˆã€‚</div>
        </div>
      </div>
      </div><!-- end content -->
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="footer-text">Â© 2026 Crypto3D</p>
    </div>
  </footer>

  <script>
    // === State ===
    let currentVersion = '6m';
    let bmriData = null;
    let mcapData = null;
    let chart = null;
    let series = {};
    let zones = {};
    let seriesVisible = { bmri: true, rates: false, liq: false, risk: false, btcMcap: false, totalMcap: false };
    let defaultRange = null;
    let historyData = {};
    let currentThresholds = { on: 0.6, off: -0.6 };

    // === Regime Logic ===
    function getRegimeInfo(regime) {
      const lang = LangUtils.get();
      if (regime === 'RISK_ON') {
        return { class: 'risk-on', label: lang === 'zh' ? 'é£é™©å¼€å¯' : 'Risk-On', state: 'ğŸŸ¢ Risk-On', hint: lang === 'zh' ? 'å®è§‚ç¯å¢ƒå‹å¥½ï¼Œé€‚åˆæŒæœ‰æˆ–åŠ ä»“' : 'Favorable macro, hold or add' };
      } else if (regime === 'RISK_OFF') {
        return { class: 'risk-off', label: lang === 'zh' ? 'é£é™©å…³é—­' : 'Risk-Off', state: 'ğŸ”´ Risk-Off', hint: lang === 'zh' ? 'å®è§‚ç¯å¢ƒæ¶åŒ–ï¼Œè€ƒè™‘å‡ä»“æˆ–å¯¹å†²' : 'Unfavorable macro, reduce or hedge' };
      }
      return { class: 'neutral', label: lang === 'zh' ? 'ä¸­æ€§' : 'Neutral', state: 'ğŸŸ¡ Neutral', hint: lang === 'zh' ? 'å®è§‚ç¯å¢ƒä¸­æ€§ï¼Œç»´æŒç°æœ‰é…ç½®' : 'Neutral macro, maintain position' };
    }

    function updateBucketBar(id, value) {
      const bar = document.getElementById(id);
      if (!bar || value === null) return;
      // Data is already 0-100 range; lower values = better (risk-on)
      const percent = Math.min(100, Math.max(0, value));
      bar.style.width = percent + '%';
      bar.className = 'bucket-fill ' + (value <= 50 ? 'positive' : 'negative');
    }

    // === Version Switch ===
    function switchVersion(version) {
      currentVersion = version;
      document.querySelectorAll('.version-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.version === version);
      });
      if (bmriData) updateDisplay();
    }

    // === Chart Controls ===
    function toggleSeries(name) {
      toggleSeriesVisibility(series, seriesVisible, name, { bmri: zones });
      const el = document.getElementById(`tooltip-${name}`);
      if (el) el.style.display = seriesVisible[name] ? 'flex' : 'none';
    }

    function resetChart() {
      if (chart && defaultRange) chart.timeScale().setVisibleRange(defaultRange);
    }

    // === Display Update ===
    function updateDisplay() {
      console.log('[BMRI] updateDisplay called, bmriData:', !!bmriData, 'currentVersion:', currentVersion);
      if (!bmriData) return;
      try {
      const versionData = bmriData[currentVersion];
      console.log('[BMRI] versionData:', !!versionData, versionData ? Object.keys(versionData) : null);
      const current = versionData.current;
      const thresholds = versionData.thresholds;
      currentThresholds = thresholds;
      const regimeInfo = getRegimeInfo(current.regime);
      console.log('[BMRI] current:', current, 'regimeInfo:', regimeInfo);

      document.getElementById('bmri-value').textContent = current.value.toFixed(1);
      document.getElementById('bmri-value').className = `stat-value ${regimeInfo.class}`;
      document.getElementById('bmri-regime').textContent = regimeInfo.label;
      document.getElementById('market-state').textContent = regimeInfo.state;
      document.getElementById('regime-hint').textContent = regimeInfo.hint;
      document.getElementById('update-date').textContent = current.date;

      document.getElementById('rates-value').textContent = current.rates !== null ? current.rates.toFixed(2) : 'â€”';
      document.getElementById('liq-value').textContent = current.liq !== null ? current.liq.toFixed(2) : 'â€”';
      document.getElementById('risk-value').textContent = current.risk !== null ? current.risk.toFixed(2) : 'â€”';

      updateBucketBar('rates-bar', current.rates);
      updateBucketBar('liq-bar', current.liq);
      updateBucketBar('risk-bar', current.risk);

      document.getElementById('threshold-on').textContent = `< ${thresholds.on} Risk-On`;
      document.getElementById('threshold-off').textContent = `> ${thresholds.off} Risk-Off`;
      document.getElementById('legend-on').textContent = `${thresholds.on}`;
      document.getElementById('legend-off').textContent = `${thresholds.off}`;

      if (bmriData.updated_at) {
        const prefix = LangUtils.get() === 'zh' ? 'æ•°æ®æ›´æ–°: ' : 'Data updated: ';
        document.getElementById('data-update-time').textContent = prefix + bmriData.updated_at;
      }

      console.log('[BMRI] Calling drawChart...');
      drawChart(versionData.history, thresholds);
      console.log('[BMRI] drawChart completed');
      } catch (err) {
        console.error('[BMRI] updateDisplay error:', err);
        console.error('[BMRI] Error stack:', err.stack);
        throw err; // Re-throw to be caught by loadData
      }
    }

    // === Data Loading ===
    async function loadData() {
      console.log('[BMRI] loadData started');
      try {
        console.log('[BMRI] Fetching data...');
        const [bmriRes, mcapRes] = await Promise.all([
          fetch('../indicators/data/bmri.json'),
          fetch('../indicators/data/mcap.json').catch(() => null)
        ]);
        console.log('[BMRI] bmriRes status:', bmriRes.status, bmriRes.ok);
        if (!bmriRes.ok) throw new Error(`HTTP ${bmriRes.status}: ${bmriRes.statusText}`);
        
        bmriData = await bmriRes.json();
        console.log('[BMRI] bmriData keys:', Object.keys(bmriData));
        if (mcapRes && mcapRes.ok) mcapData = await mcapRes.json();
        
        // Hide loading, show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
        console.log('[BMRI] Calling updateDisplay...');
        updateDisplay();
        console.log('[BMRI] updateDisplay completed');
      } catch (err) {
        console.error('[BMRI] Failed to load data:', err);
        console.error('[BMRI] Error stack:', err.stack);
        document.getElementById('loading').innerHTML = `<div style="color: var(--danger);">åŠ è½½å¤±è´¥: ${err.message}</div>`;
      }
    }

    // === Chart Drawing ===
    function drawChart(history, thresholds) {
      if (chart) { chart.remove(); chart = null; series = {}; zones = {}; }

      chart = createChart('chart-container', {
        leftPriceScale: { visible: true, mode: LightweightCharts.PriceScaleMode.Logarithmic },
      });

      // Prepare data
      const bmriDataArr = history.map(d => ({ time: d.date, value: d.bmri }));
      const ratesDataArr = history.filter(d => d.rates !== null).map(d => ({ time: d.date, value: d.rates }));
      const liqDataArr = history.filter(d => d.liq !== null).map(d => ({ time: d.date, value: d.liq }));
      const riskDataArr = history.filter(d => d.risk !== null).map(d => ({ time: d.date, value: d.risk }));
      historyData = buildHistoryLookup(history);
      const lastDate = history[history.length - 1].date;

      // Zone backgrounds
      zones.green = createZoneSeries(chart, thresholds.on, { bottomFill1: 'rgba(34, 197, 94, 0.08)', bottomFill2: 'rgba(34, 197, 94, 0.25)' });
      zones.green.setData(bmriDataArr);
      zones.red = createZoneSeries(chart, thresholds.off, { topFill1: 'rgba(239, 68, 68, 0.08)', topFill2: 'rgba(239, 68, 68, 0.25)' });
      zones.red.setData(bmriDataArr);

      // BMRI Series
      const bmriWithWhitespace = addFutureWhitespace(bmriDataArr, lastDate, 90);
      series.bmri = chart.addLineSeries({ color: '#3b82f6', lineWidth: 2, priceScaleId: 'right', priceFormat: { type: 'price', precision: 1, minMove: 0.1 }, lastValueVisible: false, priceLineVisible: false });
      series.bmri.setData(bmriWithWhitespace);

      createThresholdLine(series.bmri, thresholds.on, '#22c55e');
      createThresholdLine(series.bmri, thresholds.off, '#ef4444');
      createThresholdLine(series.bmri, 0, 'rgba(161, 161, 170, 0.3)', { axisLabelVisible: false });

      // Bucket series (hidden)
      series.rates = chart.addLineSeries({ color: '#06b6d4', lineWidth: 1.5, priceScaleId: 'right', priceFormat: { type: 'price', precision: 2, minMove: 0.01 }, lastValueVisible: false, priceLineVisible: false, visible: false });
      series.rates.setData(ratesDataArr);

      series.liq = chart.addLineSeries({ color: '#22c55e', lineWidth: 1.5, priceScaleId: 'right', priceFormat: { type: 'price', precision: 2, minMove: 0.01 }, lastValueVisible: false, priceLineVisible: false, visible: false });
      series.liq.setData(liqDataArr);

      series.risk = chart.addLineSeries({ color: '#f59e0b', lineWidth: 1.5, priceScaleId: 'right', priceFormat: { type: 'price', precision: 2, minMove: 0.01 }, lastValueVisible: false, priceLineVisible: false, visible: false });
      series.risk.setData(riskDataArr);

      // Market cap series (if available)
      if (mcapData) {
        const btcMcapData = mcapData.history.filter(d => d.btc_mcap).map(d => ({ time: d.date, value: d.btc_mcap }));
        const totalMcapData = mcapData.history.filter(d => d.total_mcap).map(d => ({ time: d.date, value: d.total_mcap }));
        
        series.btcMcap = chart.addLineSeries({ color: '#f7931a', lineWidth: 1.5, priceScaleId: 'left', priceFormat: { type: 'price', precision: 0, minMove: 1e9 }, lastValueVisible: false, priceLineVisible: false, visible: false });
        series.btcMcap.setData(btcMcapData);
        
        series.totalMcap = chart.addLineSeries({ color: '#8b5cf6', lineWidth: 1.5, priceScaleId: 'left', priceFormat: { type: 'price', precision: 0, minMove: 1e9 }, lastValueVisible: false, priceLineVisible: false, visible: false });
        series.totalMcap.setData(totalMcapData);
      }

      // Default range
      defaultRange = setDefaultRange(chart, '2013-01-01', lastDate);

      // Double-click reset
      document.getElementById('chart-container').addEventListener('dblclick', resetChart);

      // Tooltip
      const tooltip = document.getElementById('chart-tooltip');
      chart.subscribeCrosshairMove(param => {
        if (!param.time || !param.point || param.point.x < 0) { tooltip.classList.remove('visible'); return; }
        tooltip.classList.add('visible');
        document.getElementById('tooltip-date').textContent = formatTime(param.time);
        
        const dateStr = typeof param.time === 'string' ? param.time : `${param.time.year}-${String(param.time.month).padStart(2,'0')}-${String(param.time.day).padStart(2,'0')}`;
        const d = historyData[dateStr];
        const mc = mcapData?.history.find(m => m.date === dateStr);

        if (seriesVisible.bmri && d?.bmri !== undefined) { document.getElementById('tooltip-bmri').style.display = 'flex'; document.getElementById('tooltip-bmri-value').textContent = d.bmri.toFixed(1); } else { document.getElementById('tooltip-bmri').style.display = 'none'; }
        if (seriesVisible.rates && d?.rates !== undefined) { document.getElementById('tooltip-rates').style.display = 'flex'; document.getElementById('tooltip-rates-value').textContent = d.rates.toFixed(2); } else { document.getElementById('tooltip-rates').style.display = 'none'; }
        if (seriesVisible.liq && d?.liq !== undefined) { document.getElementById('tooltip-liq').style.display = 'flex'; document.getElementById('tooltip-liq-value').textContent = d.liq.toFixed(2); } else { document.getElementById('tooltip-liq').style.display = 'none'; }
        if (seriesVisible.risk && d?.risk !== undefined) { document.getElementById('tooltip-risk').style.display = 'flex'; document.getElementById('tooltip-risk-value').textContent = d.risk.toFixed(2); } else { document.getElementById('tooltip-risk').style.display = 'none'; }
        if (seriesVisible.btcMcap && mc?.btc_mcap) { document.getElementById('tooltip-btcMcap').style.display = 'flex'; document.getElementById('tooltip-btcMcap-value').textContent = formatMarketCap(mc.btc_mcap); } else { document.getElementById('tooltip-btcMcap').style.display = 'none'; }
        if (seriesVisible.totalMcap && mc?.total_mcap) { document.getElementById('tooltip-totalMcap').style.display = 'flex'; document.getElementById('tooltip-totalMcap-value').textContent = formatMarketCap(mc.total_mcap); } else { document.getElementById('tooltip-totalMcap').style.display = 'none'; }
      });
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', () => {
      LangUtils.init();
      loadData();
    });
  </script>
</body>
</html>
