<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>BMRI 指标 — Crypto3D</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../indicators/css/common.css">
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <script src="../indicators/js/chart-utils.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../" class="logo">
          <img src="../logo.svg" alt="3D" class="logo-icon">
          <span class="logo-text">Crypto3D</span>
        </a>
        <div class="nav-links">
          <a href="../" data-zh="首页" data-en="Home">首页</a>
          <a href="../ahr999/">AHR999</a>
          <div class="lang-switch" onclick="LangUtils.toggle(); updateDisplay();">
            <span id="lang-zh" class="active">中文</span>
            <span>/</span>
            <span id="lang-en">EN</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div data-zh="加载 BMRI 数据中..." data-en="Loading BMRI data...">加载 BMRI 数据中...</div>
      </div>

      <!-- Main Content (hidden until data loads) -->
      <div id="content" style="display: none;">
      <div class="page-header">
        <h1 class="page-title">BMRI <span data-zh="宏观风险指标" data-en="Macro Risk Index">宏观风险指标</span></h1>
        <p class="page-subtitle" data-zh="Bitcoin Macro Risk Index — 综合利率、流动性、风险偏好的宏观环境评估" data-en="Bitcoin Macro Risk Index — Rates, Liquidity, and Risk Appetite assessment">Bitcoin Macro Risk Index — 综合利率、流动性、风险偏好的宏观环境评估</p>
      </div>

      <!-- Version Tabs -->
      <div class="version-tabs">
        <div class="version-tab active" data-version="6m" onclick="switchVersion('6m')">
          <div>6M <span data-zh="版" data-en="Version">版</span></div>
          <div class="version-desc" data-zh="中周期趋势，1-6月调仓" data-en="Medium-term, 1-6 month rebalancing">中周期趋势，1-6月调仓</div>
        </div>
        <div class="version-tab" data-version="1m" onclick="switchVersion('1m')">
          <div>1M <span data-zh="版" data-en="Version">版</span></div>
          <div class="version-desc" data-zh="短期冲击，1-4周调仓" data-en="Short-term, 1-4 week rebalancing">短期冲击，1-4周调仓</div>
        </div>
      </div>

      <!-- Stats Cards (above chart) -->
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <div class="stat-card" style="flex: 1.5;">
          <div class="stat-label">BMRI</div>
          <div class="stat-value" id="bmri-value">—</div>
          <div class="stat-hint" id="market-state" style="font-size: 13px; line-height: 1.4;">—</div>
        </div>
        <div class="stat-card" style="flex: 1;">
          <div class="stat-label">Rates <span style="color: var(--text-tertiary);">(利率)</span></div>
          <div class="stat-value" style="font-size: 20px;" id="rates-value">—</div>
          <div class="bucket-bar"><div class="bucket-fill" id="rates-bar"></div></div>
        </div>
        <div class="stat-card" style="flex: 1;">
          <div class="stat-label">Liquidity <span style="color: var(--text-tertiary);">(流动性)</span></div>
          <div class="stat-value" style="font-size: 20px;" id="liq-value">—</div>
          <div class="bucket-bar"><div class="bucket-fill" id="liq-bar"></div></div>
        </div>
        <div class="stat-card" style="flex: 1;">
          <div class="stat-label">Risk <span style="color: var(--text-tertiary);">(风险偏好)</span></div>
          <div class="stat-value" style="font-size: 20px;" id="risk-value">—</div>
          <div class="bucket-bar"><div class="bucket-fill" id="risk-bar"></div></div>
        </div>
      </div>
      <!-- Hidden elements for JS compatibility -->
      <span id="bmri-regime" style="display:none;"></span>
      <span id="regime-hint" style="display:none;"></span>

      <!-- Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title" data-zh="BMRI 历史走势" data-en="BMRI History">BMRI 历史走势</div>
          <div class="chart-legend">
            <div class="legend-item fixed"><div class="legend-line dashed" style="color: #22c55e;"></div><span id="legend-on">30</span></div>
            <div class="legend-item fixed"><div class="legend-line dashed" style="color: #ef4444;"></div><span id="legend-off">70</span></div>
            <div class="legend-item" data-series="bmri" onclick="toggleSeries('bmri')"><div class="legend-line" style="background: #3b82f6;"></div><span>BMRI</span></div>
            <div class="legend-item disabled" data-series="rates" onclick="toggleSeries('rates')"><div class="legend-line" style="background: #06b6d4;"></div><span>Rates</span></div>
            <div class="legend-item disabled" data-series="liq" onclick="toggleSeries('liq')"><div class="legend-line" style="background: #22c55e;"></div><span>Liquidity</span></div>
            <div class="legend-item disabled" data-series="risk" onclick="toggleSeries('risk')"><div class="legend-line" style="background: #f59e0b;"></div><span>Risk</span></div>
            <div class="legend-item disabled" data-series="btcPrice" onclick="toggleSeries('btcPrice')"><div class="legend-line" style="background: #f59e0b;"></div><span data-zh="BTC价格" data-en="BTC Price">BTC价格</span></div>
            <div class="legend-item disabled" data-series="cryptoTotalMcap" onclick="toggleSeries('cryptoTotalMcap')"><div class="legend-line" style="background: #8b5cf6;"></div><span data-zh="加密总市值" data-en="Crypto Total MCap">加密总市值</span></div>
          </div>
        </div>
        <div class="chart-wrapper" id="chart-container"></div>
        <div class="chart-tooltip" id="chart-tooltip">
          <div class="tooltip-date" id="tooltip-date">—</div>
          <div class="tooltip-item" id="tooltip-bmri"><div class="tooltip-dot" style="background: #3b82f6;"></div><span class="tooltip-label">BMRI:</span><span class="tooltip-value" id="tooltip-bmri-value">—</span></div>
          <div class="tooltip-item" id="tooltip-rates" style="display:none;"><div class="tooltip-dot" style="background: #06b6d4;"></div><span class="tooltip-label">Rates:</span><span class="tooltip-value" id="tooltip-rates-value">—</span></div>
          <div class="tooltip-item" id="tooltip-liq" style="display:none;"><div class="tooltip-dot" style="background: #22c55e;"></div><span class="tooltip-label">Liq:</span><span class="tooltip-value" id="tooltip-liq-value">—</span></div>
          <div class="tooltip-item" id="tooltip-risk" style="display:none;"><div class="tooltip-dot" style="background: #f59e0b;"></div><span class="tooltip-label">Risk:</span><span class="tooltip-value" id="tooltip-risk-value">—</span></div>
          <div class="tooltip-item" id="tooltip-btcPrice" style="display:none;"><div class="tooltip-dot" style="background: #f59e0b;"></div><span class="tooltip-label">BTC:</span><span class="tooltip-value" id="tooltip-btcPrice-value">—</span></div>
          <div class="tooltip-item" id="tooltip-cryptoTotalMcap" style="display:none;"><div class="tooltip-dot" style="background: #8b5cf6;"></div><span class="tooltip-label">Crypto Total:</span><span class="tooltip-value" id="tooltip-cryptoTotalMcap-value">—</span></div>
        </div>
        <div class="chart-hint" data-zh="💡 拖动平移 · 滚轮缩放 · 双击重置" data-en="💡 Drag to pan · Scroll to zoom · Double-click to reset">💡 拖动平移 · 滚轮缩放 · 双击重置</div>
      </div>
      <div class="data-update-time" id="data-update-time">—</div>

      <!-- Info Sections -->
      <div class="info-section">
        <h2 class="info-title" data-zh="💡 什么是 BMRI？" data-en="💡 What is BMRI?">💡 什么是 BMRI？</h2>
        <div class="info-text">
          <p data-zh="BMRI（Bitcoin Macro Risk Index）是一个宏观风险评估指标，帮助你判断「现在的宏观环境对比特币是友好还是不友好」。" data-en="BMRI (Bitcoin Macro Risk Index) is a macro risk indicator that helps you determine whether the current macro environment is favorable or unfavorable for Bitcoin.">BMRI（Bitcoin Macro Risk Index）是一个宏观风险评估指标，帮助你判断「现在的宏观环境对比特币是友好还是不友好」。</p>
          <p><strong>核心逻辑：</strong>比特币虽然常被称为「数字黄金」，但它本质上是一个风险资产。当全球流动性充裕、利率下降、市场风险偏好上升时，比特币往往表现更好；反之则承压。</p>
          <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 12px 0;">
            <p style="margin: 0 0 8px 0;">🟢 <strong>Risk-On</strong>：宏观环境友好，适合持有或加仓</p>
            <p style="margin: 0 0 8px 0;">🟡 <strong>Neutral</strong>：宏观环境中性，维持现有配置</p>
            <p style="margin: 0;">🔴 <strong>Risk-Off</strong>：宏观环境恶化，考虑减仓或对冲</p>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title" data-zh="📊 三大组成部分" data-en="📊 Three Components">📊 三大组成部分</h2>
        <div class="info-text">
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0; border-left: 4px solid var(--blue);">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--blue);">📉 Rates 利率桶（权重 35%）</h3>
            <p style="margin-bottom: 8px;"><strong>监测什么：</strong>美国国债利率的变化方向</p>
            <p style="color: var(--text-tertiary); font-size: 13px;">数据来源：10年期美债名义利率 (DGS10)、10年期 TIPS 实际利率 (DFII10)</p>
          </div>
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0; border-left: 4px solid var(--accent);">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--accent);">💧 Liquidity 流动性桶（权重 35%）</h3>
            <p style="margin-bottom: 8px;"><strong>监测什么：</strong>全球美元流动性的松紧程度</p>
            <p style="color: var(--text-tertiary); font-size: 13px;">数据来源：美元指数 (DXY)、美联储资产负债表 (WALCL)、隔夜逆回购 (RRP)</p>
          </div>
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0; border-left: 4px solid var(--warning);">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--warning);">⚡ Risk 风险偏好桶（权重 30%）</h3>
            <p style="margin-bottom: 8px;"><strong>监测什么：</strong>市场的恐慌程度和信用风险</p>
            <p style="color: var(--text-tertiary); font-size: 13px;">数据来源：VIX 恐慌指数 (VIXCLS)、高收益债信用利差 (HY OAS)</p>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title" data-zh="🔄 1M 版 vs 6M 版" data-en="🔄 1M vs 6M Version">🔄 1M 版 vs 6M 版</h2>
        <div class="info-text">
          <table class="info-table">
            <thead><tr><th></th><th>6M 版（推荐）</th><th>1M 版</th></tr></thead>
            <tbody>
              <tr><td style="font-weight: 500;">适用周期</td><td>1-6 个月调仓</td><td>1-4 周调仓</td></tr>
              <tr><td style="font-weight: 500;">信号特点</td><td>更稳定，过滤噪音</td><td>更敏感，快速响应</td></tr>
              <tr><td style="font-weight: 500;">阈值</td><td>20 / 80</td><td>25 / 75</td></tr>
            </tbody>
          </table>
          <div class="disclaimer">💡 <strong>建议：</strong>大多数投资者使用 6M 版作为主要参考。如果你需要更及时的短期预警，可以叠加参考 1M 版。</div>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title">🤔 为什么需要 BMRI？</h2>
        <div class="info-text">
          <p><strong>比特币的「双重身份」困境：</strong></p>
          <p>比特币常被宣传为「数字黄金」和「通胀对冲工具」，但现实中它的表现更像是一个<strong>高贝塔风险资产</strong>——当全球风险偏好上升时暴涨，当市场恐慌时暴跌。</p>
          
          <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 16px 0;">
            <p style="margin: 0 0 12px 0;"><strong>历史数据显示：</strong></p>
            <p style="margin: 0 0 8px 0;">• 2020年3月疫情恐慌：BTC 与美股同步暴跌 50%+</p>
            <p style="margin: 0 0 8px 0;">• 2020-2021年大放水：BTC 从 $5k 涨到 $69k</p>
            <p style="margin: 0 0 8px 0;">• 2022年加息周期：BTC 从 $69k 跌到 $15k</p>
            <p style="margin: 0;">• 2023-2024年暂停加息：BTC 反弹至 $70k+</p>
          </div>
          
          <p><strong>结论：</strong>比特币的中期走势与宏观流动性环境高度相关。BMRI 就是为了量化这种关系，帮助投资者判断「现在是顺风还是逆风」。</p>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title">📈 如何看图表？</h2>
        <div class="info-text">
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0;">
            <h3 style="font-size: 15px; margin-bottom: 12px; color: var(--text-primary);">📊 BMRI 主线（蓝色）</h3>
            <p style="margin-bottom: 8px;">• <strong>数值范围：</strong>0-100，数值越低越好（Risk-On）</p>
            <p style="margin-bottom: 8px;">• <strong>绿色区域（< 20-25）：</strong>宏观环境极佳，历史上对应 BTC 大涨阶段</p>
            <p style="margin-bottom: 8px;">• <strong>红色区域（> 75-80）：</strong>宏观环境恶劣，历史上对应 BTC 调整或熊市</p>
            <p style="margin: 0;">• <strong>中间区域：</strong>宏观中性，BTC 走势更多取决于自身因素</p>
          </div>
          
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0;">
            <h3 style="font-size: 15px; margin-bottom: 12px; color: var(--text-primary);">🔍 查看子指标</h3>
            <p style="margin-bottom: 8px;">点击图例中的 <strong>Rates / Liquidity / Risk</strong> 可以显示各个子指标的走势：</p>
            <p style="margin-bottom: 8px;">• <strong>Rates（青色）：</strong>利率环境。高 = 紧缩，对 BTC 不利</p>
            <p style="margin-bottom: 8px;">• <strong>Liquidity（绿色）：</strong>流动性状况。高 = 紧缩，对 BTC 不利</p>
            <p style="margin: 0;">• <strong>Risk（橙色）：</strong>风险情绪。高 = 恐慌，对 BTC 不利</p>
          </div>
          
          <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin: 16px 0;">
            <h3 style="font-size: 15px; margin-bottom: 12px; color: var(--text-primary);">💡 实用技巧</h3>
            <p style="margin-bottom: 8px;">• <strong>拖动</strong>图表可以平移查看历史</p>
            <p style="margin-bottom: 8px;">• <strong>滚轮</strong>可以缩放时间范围</p>
            <p style="margin: 0;">• <strong>双击</strong>可以重置到默认视图</p>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title">🔗 与加密市场的关系</h2>
        <div class="info-text">
          <p><strong>BMRI 不预测价格，而是判断「环境」：</strong></p>
          
          <table class="info-table" style="margin: 16px 0;">
            <thead><tr><th>BMRI 状态</th><th>宏观环境</th><th>对 BTC 的典型影响</th></tr></thead>
            <tbody>
              <tr><td style="color: var(--accent);">🟢 Risk-On</td><td>低利率、高流动性、低恐慌</td><td>顺风，易涨难跌</td></tr>
              <tr><td style="color: var(--warning);">🟡 Neutral</td><td>混合信号</td><td>走势取决于链上/市场因素</td></tr>
              <tr><td style="color: var(--danger);">🔴 Risk-Off</td><td>高利率、紧流动性、高恐慌</td><td>逆风，易跌难涨</td></tr>
            </tbody>
          </table>
          
          <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 16px 0;">
            <p style="margin: 0 0 12px 0;"><strong>🎯 配合其他指标使用：</strong></p>
            <p style="margin: 0 0 8px 0;">• <strong>BMRI + AHR999</strong>：宏观 + 估值双重确认</p>
            <p style="margin: 0 0 8px 0;">• <strong>BMRI + MVRV</strong>：宏观 + 链上情绪</p>
            <p style="margin: 0;">• <strong>BMRI + BTC.D</strong>：宏观 + 资金流向</p>
          </div>
          
          <p><strong>重要提醒：</strong>BMRI 是宏观层面的参考，不能替代对加密市场本身的分析。即使宏观环境友好，如果链上数据显示泡沫，仍需谨慎。</p>
        </div>
      </div>

      <div class="info-section">
        <h2 class="info-title">⚠️ 局限性与风险提示</h2>
        <div class="info-text">
          <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 16px; border-radius: 8px; margin: 16px 0;">
            <p style="margin: 0 0 12px 0;"><strong>📌 使用前请了解：</strong></p>
            <p style="margin: 0 0 8px 0;">1. <strong>滞后性：</strong>宏观数据通常有 1-2 天延迟，不适合短线交易</p>
            <p style="margin: 0 0 8px 0;">2. <strong>相关性不等于因果：</strong>历史相关性可能在未来失效</p>
            <p style="margin: 0 0 8px 0;">3. <strong>黑天鹅事件：</strong>突发事件（如监管政策）可能打破宏观逻辑</p>
            <p style="margin: 0 0 8px 0;">4. <strong>非投资建议：</strong>本指标仅供参考，不构成任何投资建议</p>
            <p style="margin: 0;">5. <strong>个人风险：</strong>请根据自身风险承受能力做出决策</p>
          </div>
        </div>
      </div>
      </div><!-- end content -->
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="footer-text">© 2026 Crypto3D</p>
    </div>
  </footer>

  <script>
    // === State ===
    let currentVersion = '6m';
    let bmriData = null;
    let marketcapData = null;
    let chart = null;
    let series = {};
    let zones = {};
    let seriesVisible = { bmri: true, rates: false, liq: false, risk: false, btcPrice: false, cryptoTotalMcap: false };
    let btcPriceData = null;
    let defaultRange = null;
    let historyData = {};
    let currentThresholds = { on: 0.6, off: -0.6 };

    // === Regime Logic ===
    function getRegimeInfo(regime) {
      const lang = LangUtils.get();
      if (regime === 'RISK_ON') {
        return { 
          class: 'risk-on', 
          label: lang === 'zh' ? '风险开启' : 'Risk-On', 
          state: lang === 'zh' ? '🟢 Risk-On：宏观环境友好，适合持有或加仓' : '🟢 Risk-On: Favorable macro, hold or add'
        };
      } else if (regime === 'RISK_OFF') {
        return { 
          class: 'risk-off', 
          label: lang === 'zh' ? '风险关闭' : 'Risk-Off', 
          state: lang === 'zh' ? '🔴 Risk-Off：宏观环境恶化，考虑减仓或对冲' : '🔴 Risk-Off: Unfavorable macro, reduce or hedge'
        };
      }
      return { 
        class: 'neutral', 
        label: lang === 'zh' ? '中性' : 'Neutral', 
        state: lang === 'zh' ? '🟡 Neutral：宏观环境中性，维持现有配置' : '🟡 Neutral: Neutral macro, maintain position'
      };
    }

    function updateBucketBar(id, value) {
      const bar = document.getElementById(id);
      if (!bar || value === null) return;
      // Data is already 0-100 range; lower values = better (risk-on)
      const percent = Math.min(100, Math.max(0, value));
      bar.style.width = percent + '%';
      bar.className = 'bucket-fill ' + (value <= 50 ? 'positive' : 'negative');
    }

    // === Version Switch ===
    function switchVersion(version) {
      currentVersion = version;
      document.querySelectorAll('.version-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.version === version);
      });
      if (bmriData) updateDisplay();
    }

    // === Chart Controls ===
    function toggleSeries(name) {
      toggleSeriesVisibility(series, seriesVisible, name, { bmri: zones });
      const el = document.getElementById(`tooltip-${name}`);
      if (el) el.style.display = seriesVisible[name] ? 'flex' : 'none';
      // Show left price scale if btcPrice or cryptoTotalMcap is visible
      const showLeftScale = seriesVisible.btcPrice || seriesVisible.cryptoTotalMcap;
      chart.priceScale('left').applyOptions({ visible: showLeftScale });
    }

    function resetChart() {
      if (chart && defaultRange) chart.timeScale().setVisibleRange(defaultRange);
    }

    // === Display Update ===
    function updateDisplay() {
      if (!bmriData) return;
      try {
      const versionData = bmriData[currentVersion];
      const current = versionData.current;
      const thresholds = versionData.thresholds;
      currentThresholds = thresholds;
      const regimeInfo = getRegimeInfo(current.regime);

      document.getElementById('bmri-value').textContent = current.value.toFixed(1);
      document.getElementById('bmri-value').className = `stat-value ${regimeInfo.class}`;
      document.getElementById('bmri-regime').textContent = regimeInfo.label;
      document.getElementById('market-state').textContent = regimeInfo.state;

      document.getElementById('rates-value').textContent = current.rates !== null ? current.rates.toFixed(2) : '—';
      document.getElementById('liq-value').textContent = current.liq !== null ? current.liq.toFixed(2) : '—';
      document.getElementById('risk-value').textContent = current.risk !== null ? current.risk.toFixed(2) : '—';

      updateBucketBar('rates-bar', current.rates);
      updateBucketBar('liq-bar', current.liq);
      updateBucketBar('risk-bar', current.risk);

      document.getElementById('legend-on').textContent = `${thresholds.on}`;
      document.getElementById('legend-off').textContent = `${thresholds.off}`;

      if (bmriData.updated_at) {
        const prefix = LangUtils.get() === 'zh' ? '数据更新: ' : 'Data updated: ';
        document.getElementById('data-update-time').textContent = prefix + bmriData.updated_at;
      }

      drawChart(versionData.history, thresholds);
      } catch (err) {
        console.error('[BMRI] updateDisplay error:', err);
        console.error('[BMRI] Error stack:', err.stack);
        throw err; // Re-throw to be caught by loadData
      }
    }

    // === Data Loading ===
    async function loadData() {
      try {
        const [bmriRes, marketcapRes, btcPriceRes] = await Promise.all([
          fetch('../indicators/data/bmri.json'),
          fetch('../indicators/data/marketcap.json').catch(() => null),
          fetch('../indicators/data/shared/btc-price.json')
        ]);
        if (!bmriRes.ok) throw new Error(`HTTP ${bmriRes.status}: ${bmriRes.statusText}`);

        bmriData = await bmriRes.json();
        if (marketcapRes && marketcapRes.ok) marketcapData = await marketcapRes.json();
        if (btcPriceRes && btcPriceRes.ok) btcPriceData = await btcPriceRes.json();

        // Hide loading, show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        updateDisplay();
      } catch (err) {
        console.error('[BMRI] Failed to load data:', err);
        console.error('[BMRI] Error stack:', err.stack);
        document.getElementById('loading').innerHTML = `<div style="color: var(--danger);">加载失败: ${err.message}</div>`;
      }
    }

    // === Chart Drawing ===
    function drawChart(history, thresholds) {
      if (chart) { chart.remove(); chart = null; series = {}; zones = {}; }

      chart = createChart('chart-container', {
        leftPriceScale: { visible: true, mode: LightweightCharts.PriceScaleMode.Logarithmic },
      });

      // Prepare data
      const bmriDataArr = history.map(d => ({ time: d.date, value: d.bmri }));
      const ratesDataArr = history.filter(d => d.rates !== null).map(d => ({ time: d.date, value: d.rates }));
      const liqDataArr = history.filter(d => d.liq !== null).map(d => ({ time: d.date, value: d.liq }));
      const riskDataArr = history.filter(d => d.risk !== null).map(d => ({ time: d.date, value: d.risk }));
      historyData = buildHistoryLookup(history);
      const lastDate = history[history.length - 1].date;

      // Zone backgrounds
      zones.green = createZoneSeries(chart, thresholds.on, { bottomFill1: 'rgba(34, 197, 94, 0.08)', bottomFill2: 'rgba(34, 197, 94, 0.25)' });
      zones.green.setData(bmriDataArr);
      zones.red = createZoneSeries(chart, thresholds.off, { topFill1: 'rgba(239, 68, 68, 0.08)', topFill2: 'rgba(239, 68, 68, 0.25)' });
      zones.red.setData(bmriDataArr);

      // BMRI Series
      const bmriWithWhitespace = addFutureWhitespace(bmriDataArr, lastDate, 90);
      series.bmri = chart.addLineSeries({ color: '#3b82f6', lineWidth: 2, priceScaleId: 'right', priceFormat: { type: 'price', precision: 1, minMove: 0.1 }, lastValueVisible: false, priceLineVisible: false });
      series.bmri.setData(bmriWithWhitespace);

      createThresholdLine(series.bmri, thresholds.on, '#22c55e');
      createThresholdLine(series.bmri, thresholds.off, '#ef4444');
      createThresholdLine(series.bmri, 0, 'rgba(161, 161, 170, 0.3)', { axisLabelVisible: false });

      // Bucket series (hidden)
      series.rates = chart.addLineSeries({ color: '#06b6d4', lineWidth: 1.5, priceScaleId: 'right', priceFormat: { type: 'price', precision: 2, minMove: 0.01 }, lastValueVisible: false, priceLineVisible: false, visible: false });
      series.rates.setData(ratesDataArr);

      series.liq = chart.addLineSeries({ color: '#22c55e', lineWidth: 1.5, priceScaleId: 'right', priceFormat: { type: 'price', precision: 2, minMove: 0.01 }, lastValueVisible: false, priceLineVisible: false, visible: false });
      series.liq.setData(liqDataArr);

      series.risk = chart.addLineSeries({ color: '#f59e0b', lineWidth: 1.5, priceScaleId: 'right', priceFormat: { type: 'price', precision: 2, minMove: 0.01 }, lastValueVisible: false, priceLineVisible: false, visible: false });
      series.risk.setData(riskDataArr);

      // BTC Price series (from shared data, independent of BMRI date range)
      if (btcPriceData) {
        const btcPriceChartData = btcPriceData.history.map(d => ({
          time: d.date,
          value: d.price
        })).filter(d => d.value !== null);
        
        series.btcPrice = chart.addLineSeries({
          color: '#f59e0b',
          lineWidth: 2,
          priceScaleId: 'left',
          priceFormat: { type: 'price', precision: 0, minMove: 1 },
          lastValueVisible: false,
          priceLineVisible: false,
          visible: false,
        });
        series.btcPrice.setData(btcPriceChartData);
      }

      // Crypto Total Market Cap series (use total_mcap directly from marketcap.json)
      if (marketcapData) {
        const cryptoTotalMcapData = marketcapData
          .filter(d => d.total_mcap)
          .map(d => ({ time: d.date, value: d.total_mcap }));

        series.cryptoTotalMcap = chart.addLineSeries({
          color: '#8b5cf6',
          lineWidth: 1.5,
          priceScaleId: 'left',
          priceFormat: { type: 'price', precision: 0, minMove: 1e9 },
          lastValueVisible: false,
          priceLineVisible: false,
          visible: false,
        });
        series.cryptoTotalMcap.setData(cryptoTotalMcapData);
      }

      // Default range (start from 2014)
      defaultRange = setDefaultRange(chart, '2014-01-01', lastDate);

      // Double-click reset
      document.getElementById('chart-container').addEventListener('dblclick', resetChart);

      // Tooltip
      chart.subscribeCrosshairMove(param => {
        if (!param.time || !param.point || param.point.x < 0) {
          document.getElementById('tooltip-date').textContent = '—';
          document.getElementById('tooltip-bmri-value').textContent = '—';
          document.getElementById('tooltip-rates-value').textContent = '—';
          document.getElementById('tooltip-liq-value').textContent = '—';
          document.getElementById('tooltip-risk-value').textContent = '—';
          document.getElementById('tooltip-btcPrice-value').textContent = '—';
          document.getElementById('tooltip-cryptoTotalMcap-value').textContent = '—';
          return;
        }
        document.getElementById('tooltip-date').textContent = formatTime(param.time);
        
        const dateStr = typeof param.time === 'string' ? param.time : `${param.time.year}-${String(param.time.month).padStart(2,'0')}-${String(param.time.day).padStart(2,'0')}`;
        const d = historyData[dateStr];
        const mc = marketcapData?.find(m => m.date === dateStr);
        const priceRecord = btcPriceData?.history.find(p => p.date === dateStr);

        document.getElementById('tooltip-bmri-value').textContent = d?.bmri !== undefined ? d.bmri.toFixed(1) : '—';
        if (seriesVisible.rates) { document.getElementById('tooltip-rates').style.display = 'flex'; document.getElementById('tooltip-rates-value').textContent = d?.rates !== undefined ? d.rates.toFixed(2) : '—'; } else { document.getElementById('tooltip-rates').style.display = 'none'; }
        if (seriesVisible.liq) { document.getElementById('tooltip-liq').style.display = 'flex'; document.getElementById('tooltip-liq-value').textContent = d?.liq !== undefined ? d.liq.toFixed(2) : '—'; } else { document.getElementById('tooltip-liq').style.display = 'none'; }
        if (seriesVisible.risk) { document.getElementById('tooltip-risk').style.display = 'flex'; document.getElementById('tooltip-risk-value').textContent = d?.risk !== undefined ? d.risk.toFixed(2) : '—'; } else { document.getElementById('tooltip-risk').style.display = 'none'; }
        if (seriesVisible.btcPrice) { document.getElementById('tooltip-btcPrice').style.display = 'flex'; document.getElementById('tooltip-btcPrice-value').textContent = priceRecord?.price ? '$' + priceRecord.price.toLocaleString() : '—'; } else { document.getElementById('tooltip-btcPrice').style.display = 'none'; }
        if (seriesVisible.cryptoTotalMcap) { document.getElementById('tooltip-cryptoTotalMcap').style.display = 'flex'; document.getElementById('tooltip-cryptoTotalMcap-value').textContent = mc?.total_mcap ? formatMarketCap(mc.total_mcap) : '—'; } else { document.getElementById('tooltip-cryptoTotalMcap').style.display = 'none'; }
      });
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', () => {
      LangUtils.init();
      loadData();
    });
  </script>
</body>
</html>
